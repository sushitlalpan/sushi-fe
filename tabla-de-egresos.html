<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Panel de Administración - Egresos</title>
    <link rel="stylesheet" href="css/tabla-de-egresos.css">
</head>
<body>
    <main id="main-content">
        <header>
            <h1>Panel de Administración - Egresos</h1>
        </header>

        <div class="filters-container">
            <div class="filter-group">
                <label for="startDate">Fecha de Compra (Desde):</label>
                <input type="date" id="startDate">
            </div>
            <div class="filter-group">
                <label for="endDate">Fecha de Compra (Hasta):</label>
                <input type="date" id="endDate">
            </div>
            <div class="filter-group">
                <label for="sucursalFilter">Filtrar por Sucursal:</label>
                <select id="sucursalFilter">
                    <option value="">Todas las Sucursales</option>
                    </select>
            </div>
            <button id="applyFilters">Aplicar Filtros</button>
            <button id="clearFilters">Limpiar Filtros</button>
            <button id="downloadExcelBtn">Descargar Excel Formateado</button>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>FECHA DE COMPRA</th>
                        <th>COMPRA</th>
                        <th>LUGAR DE COMPRA</th>
                        <th>CONCEPTO</th>
                        <th>SUCURSAL</th>
                        <th>CANTIDAD</th>
                        <th>UDM</th>
                        <th>PRECIO</th>
                        <th>COSTO X UDM</th>
                        <th>ESTADO</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </main>
    <script src="js/api-client.js"></script>
    <script src="js/egresos.js"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        loadData();
    });
    
    const tableBody = document.querySelector('tbody');
    const tableHeaderRow = document.querySelector('thead tr');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const sucursalFilterSelect = document.getElementById('sucursalFilter');
    const applyFiltersBtn = document.getElementById('applyFilters');
    const clearFiltersBtn = document.getElementById('clearFilters');
    const downloadExcelBtn = document.getElementById('downloadExcelBtn');

    let allTableRowsData = [];
    let currentFilteredAndRenderedRows = [];
    let currentHeaderColCount = 10;
    const columnsToAggregate = { 'precio': 7 };

    function parseNumber(value) {
        if (typeof value === 'string') {
            value = value.replace('$', '').replace(/\./g, '').replace(/,/g, '.');
        }
        const num = parseFloat(value);
        return isNaN(num) ? 0 : num;
    }

    function formatCurrency(value) {
        return value.toLocaleString('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }

    function updateTableHeader(showObservationColumn) {
        const observationHeader = document.querySelector('.observation-header');
        if (showObservationColumn && !observationHeader) {
            const newTh = document.createElement('th');
            newTh.textContent = 'OBSERVACIÓN';
            newTh.classList.add('observation-header');
            tableHeaderRow.appendChild(newTh);
            currentHeaderColCount = 11;
        } else if (!showObservationColumn && observationHeader) {
            observationHeader.remove();
            currentHeaderColCount = 10;
        }
    }

    function formatDateForDisplay(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const userTimezoneOffset = date.getTimezoneOffset() * 60000;
        const correctedDate = new Date(date.getTime() + userTimezoneOffset);
        return correctedDate.toLocaleDateString('es-CO', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    function normalizeDate(dateString) {
        if (!dateString) return null;
        const [year, month, day] = dateString.split('-').map(Number);
        return new Date(Date.UTC(year, month - 1, day));
    }

    async function loadData() {
        try {
            const data = await egresosAPI.getEgresosList();
            const records = data.expenses || [];

            if (records.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="${currentHeaderColCount}" class="no-data-cell">No hay datos para mostrar.</td></tr>`;
                return;
            }

            allTableRowsData = records.map((record, index) => {
                const cantidad = parseNumber(record.quantity || 0);
                const totalAmount = parseNumber(record.total_amount || 0);
                const costoUDM = cantidad > 0 ? (totalAmount / cantidad) : 0;
                
                return {
                    id: record.id || index,
                    date: record.expense_date || '',
                    compra: record.expense_description || '',
                    lugarCompra: record.vendor_payee || '',
                    concepto: record.expense_category || '',
                    sucursal: record.branch_name || '',
                    cantidad: record.quantity || '',
                    udm: record.unit_of_measure || '',
                    precio: record.total_amount || 0,
                    costoUDM: costoUDM.toFixed(2),
                    status: 'white',
                    observation: ''
                };
            });

            const uniqueSucursales = new Set(allTableRowsData.map(row => row.sucursal).filter(Boolean));
            populateSucursalFilter(uniqueSucursales);
            renderTable(allTableRowsData);

        } catch (error) {
            console.error('Error al cargar los datos:', error);
            tableBody.innerHTML = `<tr><td colspan="${currentHeaderColCount}" class="no-data-cell">Error al cargar datos: ${error.message}.</td></tr>`;
        }
    }

    function calculateAndDisplayTotals(data) {
        const existingSummaryRows = tableBody.querySelectorAll('.summary-row');
        existingSummaryRows.forEach(row => row.remove());

        if (data.length === 0) return;

        let totalPrecio = data.reduce((sum, row) => sum + parseNumber(row.precio), 0);
        const averagePrecio = data.length > 0 ? totalPrecio / data.length : 0;

        const appendCell = (row, content) => {
            const cell = row.insertCell();
            cell.textContent = content;
            return cell;
        };

        const totalRow = tableBody.insertRow();
        totalRow.className = 'summary-row total';
        appendCell(totalRow, 'TOTALES').colSpan = 7;
        for (let i = 7; i < currentHeaderColCount; i++) {
            const cell = totalRow.insertCell();
            if (i === columnsToAggregate['precio']) cell.textContent = formatCurrency(totalPrecio);
        }
        
        const averageRow = tableBody.insertRow();
        averageRow.className = 'summary-row average';
        appendCell(averageRow, 'PROMEDIOS').colSpan = 7;
        for (let i = 7; i < currentHeaderColCount; i++) {
            const cell = averageRow.insertCell();
            if (i === columnsToAggregate['precio']) cell.textContent = formatCurrency(averagePrecio);
        }
    }

    function renderTable(dataToRender) {
        tableBody.innerHTML = '';
        currentFilteredAndRenderedRows = dataToRender;

        const needsObservationColumn = dataToRender.some(row => row.status === 'red');
        updateTableHeader(needsObservationColumn);

        if (dataToRender.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${currentHeaderColCount}" class="no-data-cell">No hay datos que coincidan con los filtros.</td></tr>`;
            return;
        }

        dataToRender.forEach(rowData => {
            const newRow = tableBody.insertRow();
            newRow.dataset.status = rowData.status;
            newRow.dataset.rowId = rowData.id;

            newRow.insertCell().textContent = formatDateForDisplay(rowData.date);
            newRow.insertCell().textContent = rowData.compra;
            newRow.insertCell().textContent = rowData.lugarCompra;
            newRow.insertCell().textContent = rowData.concepto;
            newRow.insertCell().textContent = rowData.sucursal;
            newRow.insertCell().textContent = rowData.cantidad;
            newRow.insertCell().textContent = rowData.udm;
            newRow.insertCell().textContent = formatCurrency(parseNumber(rowData.precio));
            newRow.insertCell().textContent = rowData.costoUDM;

            const statusCell = newRow.insertCell();
            const selectElement = document.createElement('select');
            selectElement.className = 'color-select';
            selectElement.innerHTML = `<option value="white">Blanco</option><option value="green">Verde</option><option value="red">Rojo</option>`;
            selectElement.value = rowData.status;
            statusCell.appendChild(selectElement);

            if (needsObservationColumn) {
                const observationCell = newRow.insertCell();
                observationCell.className = 'observation-cell';
                const observationInput = document.createElement('input');
                observationInput.type = 'text';
                observationInput.className = 'observation-input';
                observationInput.placeholder = 'Escribir observación...';
                observationInput.value = rowData.observation;
                
                observationInput.addEventListener('input', function() {
                    const targetRow = allTableRowsData.find(r => r.id == newRow.dataset.rowId);
                    if (targetRow) targetRow.observation = this.value;
                });
                observationCell.appendChild(observationInput);
                observationCell.style.display = (rowData.status === 'red') ? '' : 'none';
            }

            selectElement.addEventListener('change', function() {
                const selectedStatus = this.value;
                const targetRow = allTableRowsData.find(r => r.id == newRow.dataset.rowId);
                if(targetRow) {
                    targetRow.status = selectedStatus;
                    if (selectedStatus !== 'red') {
                        targetRow.observation = '';
                    }
                }
                applyFilters();
            });
        });
        calculateAndDisplayTotals(dataToRender);
    }

    function populateSucursalFilter(uniqueSucursales) {
        sucursalFilterSelect.innerHTML = '<option value="">Todas las Sucursales</option>';
        Array.from(uniqueSucursales).sort().forEach(sucursal => {
            sucursalFilterSelect.innerHTML += `<option value="${sucursal}">${sucursal}</option>`;
        });
    }

    function applyFilters() {
        const filterStartDate = startDateInput.value ? normalizeDate(startDateInput.value) : null;
        const filterEndDate = endDateInput.value ? normalizeDate(endDateInput.value) : null;
        const selectedSucursal = sucursalFilterSelect.value;

        const filteredRows = allTableRowsData.filter(row => {
            const rowDateNormalized = normalizeDate(row.date.split(' ')[0]);
            const dateMatch = (!filterStartDate || (rowDateNormalized && rowDateNormalized >= filterStartDate)) &&
                              (!filterEndDate || (rowDateNormalized && rowDateNormalized <= filterEndDate));
            const sucursalMatch = !selectedSucursal || row.sucursal === selectedSucursal;
            return dateMatch && sucursalMatch;
        });
        renderTable(filteredRows);
    }

    function clearFilters() {
        startDateInput.value = '';
        endDateInput.value = '';
        sucursalFilterSelect.value = '';
        renderTable(allTableRowsData);
    }

    async function downloadExcel() {
        if (currentFilteredAndRenderedRows.length === 0) {
            alert("No hay datos para descargar.");
            return;
        }
        try {
            const blob = await egresosAPI.downloadEgresos(currentFilteredAndRenderedRows);
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'reporte_egresos_formateado.xlsx';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();

        } catch (error) {
            console.error('Error en la descarga:', error);
            alert(`No se pudo descargar el archivo: ${error.message}`);
        }
    }

    applyFiltersBtn.addEventListener('click', applyFilters);
    clearFiltersBtn.addEventListener('click', clearFilters);
    downloadExcelBtn.addEventListener('click', downloadExcel);
    
    </script>
</body>
</html>
