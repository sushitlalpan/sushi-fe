<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Panel de Administración - Egresos</title>
    <link rel="stylesheet" href="css/tabla-de-egresos.css">
</head>
<body>
    <main id="main-content">
        <header>
            <h1>Panel de Administración - Egresos</h1>
        </header>

        <div class="filters-container">
            <div class="filter-group">
                <label for="startDate">Fecha de Compra (Desde):</label>
                <input type="date" id="startDate">
            </div>
            <div class="filter-group">
                <label for="endDate">Fecha de Compra (Hasta):</label>
                <input type="date" id="endDate">
            </div>
            <div class="filter-group">
                <label for="sucursalFilter">Filtrar por Sucursal:</label>
                <select id="sucursalFilter">
                    <option value="">Todas las Sucursales</option>
                    </select>
            </div>
            <button id="applyFilters">Aplicar Filtros</button>
            <button id="clearFilters">Limpiar Filtros</button>
            <button id="downloadExcelBtn">Descargar Excel Formateado</button>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>FECHA DE COMPRA</th>
                        <th>COMPRA</th>
                        <th>LUGAR DE COMPRA</th>
                        <th>CONCEPTO</th>
                        <th>SUCURSAL</th>
                        <th>CANTIDAD</th>
                        <th>UDM</th>
                        <th>PRECIO</th>
                        <th>COSTO X UDM</th>
                        <th>ESTADO</th>
                        <th>ACCIONES</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            
            <!-- Pagination Controls -->
            <div class="pagination-container" style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
                <div class="pagination-info">
                    <span id="recordsInfo">Registros: 0 de 0</span>
                </div>
                <div class="pagination-controls">
                    <button id="firstPageBtn" onclick="goToPage(1)" disabled>Primera</button>
                    <button id="prevPageBtn" onclick="goToPage(currentPage - 1)" disabled>Anterior</button>
                    <span id="pageInfo">Página 1 de 1</span>
                    <button id="nextPageBtn" onclick="goToPage(currentPage + 1)" disabled>Siguiente</button>
                    <button id="lastPageBtn" onclick="goToPage(totalPages)" disabled>Última</button>
                </div>
            </div>
        </div>
    </main>
    <script src="js/api-client.js"></script>
    <script src="js/egresos.js"></script>
    <script src="js/branches.js"></script>
    <script>
    // Pagination functions
    function updatePaginationUI() {
        document.getElementById('recordsInfo').textContent = `Registros: ${((currentPage - 1) * recordsPerPage) + 1}-${Math.min(currentPage * recordsPerPage, totalRecords)} de ${totalRecords}`;
        document.getElementById('pageInfo').textContent = `Página ${currentPage} de ${totalPages}`;
        
        document.getElementById('firstPageBtn').disabled = currentPage <= 1;
        document.getElementById('prevPageBtn').disabled = currentPage <= 1;
        document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
        document.getElementById('lastPageBtn').disabled = currentPage >= totalPages;
    }
    
    async function goToPage(page) {
        if (page < 1 || page > totalPages || page === currentPage) return;
        await loadData(page);
    }
    
    document.addEventListener("DOMContentLoaded", async function() {
        await loadAllBranches();
        await loadData();
    });
    
    const tableBody = document.querySelector('tbody');
    const tableHeaderRow = document.querySelector('thead tr');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const sucursalFilterSelect = document.getElementById('sucursalFilter');
    const applyFiltersBtn = document.getElementById('applyFilters');
    const clearFiltersBtn = document.getElementById('clearFilters');
    const downloadExcelBtn = document.getElementById('downloadExcelBtn');

    let allTableRowsData = [];
    let currentFilteredAndRenderedRows = [];
    const currentHeaderColCount = 12; // Fixed: always includes observation column
    
    // Pagination variables
    let currentPage = 1;
    let totalPages = 1;
    let totalRecords = 0;
    const recordsPerPage = 100;
    const columnsToAggregate = { 'precio': 7 };
    
    // Current filters
    let currentFilters = {};
    
    // Track if branches are loaded
    let branchesLoaded = false;

    function parseNumber(value) {
        const num = parseFloat(value);
        return isNaN(num) ? 0 : num;
    }

    function formatCurrency(value) {
        return value.toLocaleString('es-MX', { style: 'currency', currency: 'MXN', minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function formatWholeNumber(value) {
        const num = parseNumber(value);
        return num.toLocaleString('es-MX', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }

    // Observation column is always visible
    function updateTableHeader() {
        const observationHeader = tableHeaderRow.querySelector('.observation-header');
        if (!observationHeader) {
            const newTh = document.createElement('th');
            newTh.textContent = 'OBSERVACIONES';
            newTh.classList.add('observation-header');
            // Insert before ACCIONES column
            const accionesHeader = tableHeaderRow.querySelector('th:last-child');
            tableHeaderRow.insertBefore(newTh, accionesHeader);
        }
    }

    function formatDateForDisplay(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const userTimezoneOffset = date.getTimezoneOffset() * 60000;
        const correctedDate = new Date(date.getTime() + userTimezoneOffset);
        return correctedDate.toLocaleDateString('es-CO', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    function normalizeDate(dateString) {
        if (!dateString) return null;
        const [year, month, day] = dateString.split('-').map(Number);
        return new Date(Date.UTC(year, month - 1, day));
    }

    async function loadAllBranches() {
        if (branchesLoaded) return; // Only load once
        
        try {
            const result = await branchesAPI.getBranches();
            if (result.branches && result.branches.length > 0) {
                const sortedBranches = result.branches.sort((a, b) => a.name.localeCompare(b.name));
                populateSucursalFilter(sortedBranches);
                branchesLoaded = true;
            }
        } catch (error) {
            console.error('Error al cargar sucursales:', error);
        }
    }

    async function loadData(page = 1, filters = null) {
        try {
            // Use provided filters or keep current filters
            if (filters !== null) {
                currentFilters = filters;
            }
            
            const skip = (page - 1) * recordsPerPage;
            const data = await egresosAPI.getEgresosList(skip, currentFilters);
            const records = data.expenses || [];
            
            // Update pagination info
            totalRecords = data.total_count || 0;
            currentPage = page;
            totalPages = Math.ceil(totalRecords / recordsPerPage);
            updatePaginationUI();

            if (records.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="${currentHeaderColCount}" class="no-data-cell">No hay datos para mostrar.</td></tr>`;
                return;
            }

            allTableRowsData = records.map((record, index) => {
                return {
                    id: record.id || index,
                    date: record.expense_date || '',
                    compra: record.expense_description || '',
                    lugarCompra: record.vendor_payee || '',
                    concepto: record.expense_category || '',
                    sucursal: record.branch_name || '',
                    cantidad: record.quantity || '',
                    udm: record.unit_of_measure || '',
                    precio: record.total_amount || 0,
                    costoUDM: record.unit_cost || 0,
                    status: record.review_state || 'pending',
                    observation: record.review_observations || ''
                };
            });

            renderTable(allTableRowsData);

        } catch (error) {
            console.error('Error al cargar los datos:', error);
            tableBody.innerHTML = `<tr><td colspan="${currentHeaderColCount}" class="no-data-cell">Error al cargar datos: ${error.message}.</td></tr>`;
        }
    }

    function calculateAndDisplayTotals(data) {
        const existingSummaryRows = tableBody.querySelectorAll('.summary-row');
        existingSummaryRows.forEach(row => row.remove());

        if (data.length === 0) return;

        let totalPrecio = data.reduce((sum, row) => sum + parseNumber(row.precio), 0);
        const averagePrecio = data.length > 0 ? totalPrecio / data.length : 0;

        const appendCell = (row, content) => {
            const cell = row.insertCell();
            cell.textContent = content;
            return cell;
        };

        const totalRow = tableBody.insertRow();
        totalRow.className = 'summary-row total';
        appendCell(totalRow, 'TOTALES').colSpan = 7;
        for (let i = 7; i < currentHeaderColCount; i++) {
            const cell = totalRow.insertCell();
            if (i === columnsToAggregate['precio']) cell.textContent = formatCurrency(totalPrecio);
        }
        
        const averageRow = tableBody.insertRow();
        averageRow.className = 'summary-row average';
        appendCell(averageRow, 'PROMEDIOS').colSpan = 7;
        for (let i = 7; i < currentHeaderColCount; i++) {
            const cell = averageRow.insertCell();
            if (i === columnsToAggregate['precio']) cell.textContent = formatCurrency(averagePrecio);
        }
    }

    function renderTable(dataToRender) {
        tableBody.innerHTML = '';
        currentFilteredAndRenderedRows = dataToRender;

        updateTableHeader();

        if (dataToRender.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${currentHeaderColCount}" class="no-data-cell">No hay datos que coincidan con los filtros.</td></tr>`;
            return;
        }

        dataToRender.forEach(rowData => {
            const newRow = tableBody.insertRow();
            newRow.dataset.status = rowData.status;
            newRow.dataset.rowId = rowData.id;

            newRow.insertCell().textContent = formatDateForDisplay(rowData.date);
            newRow.insertCell().textContent = rowData.compra;
            newRow.insertCell().textContent = rowData.lugarCompra;
            newRow.insertCell().textContent = rowData.concepto;
            newRow.insertCell().textContent = rowData.sucursal;
            newRow.insertCell().textContent = formatWholeNumber(rowData.cantidad);
            newRow.insertCell().textContent = rowData.udm;
            newRow.insertCell().textContent = formatCurrency(parseNumber(rowData.precio));
            newRow.insertCell().textContent = formatCurrency(parseNumber(rowData.costoUDM));

            const statusCell = newRow.insertCell();
            const selectElement = document.createElement('select');
            selectElement.className = 'color-select';
            selectElement.innerHTML = `<option value="pending">Blanco</option><option value="approved">Verde</option><option value="rejected">Rojo</option>`;
            selectElement.value = rowData.status;
            statusCell.appendChild(selectElement);

            // Always add observation cell
            const observationCell = newRow.insertCell();
            observationCell.className = 'observation-cell';
            const observationInput = document.createElement('input');
            observationInput.type = 'text';
            observationInput.className = 'observation-input';
            observationInput.placeholder = 'Escribir observación...';
            observationInput.value = rowData.observation;
            
            observationInput.addEventListener('input', function() {
                const targetRow = allTableRowsData.find(r => r.id == newRow.dataset.rowId);
                if (targetRow) targetRow.observation = this.value;
            });
            observationInput.addEventListener('keydown', async function(e) {
                if (e.key === 'Enter') {
                    const targetRow = allTableRowsData.find(r => r.id == newRow.dataset.rowId);
                    if (targetRow && targetRow.id) {
                        try {
                            await egresosAPI.reviewExpense(targetRow.id, {
                                review_state: targetRow.status || 'pending',
                                review_observations: this.value
                            });
                            console.log('Expense observation updated successfully');
                            alert('Observación actualizada correctamente');
                        } catch (error) {
                            console.error('Error updating expense observation:', error);
                        }
                    }
                }
            });
            observationCell.appendChild(observationInput);

            selectElement.addEventListener('change', async function() {
                const selectedStatus = this.value;
                const targetRow = allTableRowsData.find(r => r.id == newRow.dataset.rowId);
                if(targetRow) {
                    targetRow.status = selectedStatus;
                    if (selectedStatus !== 'rejected') {
                        targetRow.observation = '';
                    }
                    // Call review API
                    if (targetRow.id) {
                        try {
                            // Get current observation from input field
                            const observationInput = newRow.querySelector('.observation-input');
                            const currentObservation = observationInput ? observationInput.value : (targetRow.observation || '');
                            await egresosAPI.reviewExpense(targetRow.id, {
                                review_state: selectedStatus,
                                review_observations: currentObservation
                            });
                            console.log('Expense status updated successfully');
                        } catch (error) {
                            console.error('Error updating expense status:', error);
                        }
                    }
                }
                applyFilters();
            });

            // Add delete button
            const deleteCell = newRow.insertCell();
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Eliminar';
            deleteButton.className = 'delete-btn';
            deleteButton.style.cssText = 'background-color: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;';
            deleteButton.addEventListener('click', async function() {
                if (confirm('¿Estás seguro de que quieres eliminar este registro?')) {
                    try {
                        await egresosAPI.deleteExpense(rowData.id);
                        alert('Registro eliminado correctamente');
                        loadData(); // Reload data from server
                    } catch (error) {
                        console.error('Error deleting record:', error);
                        alert('Error al eliminar el registro');
                    }
                }
            });
            deleteCell.appendChild(deleteButton);
        });
        calculateAndDisplayTotals(dataToRender);
    }

    function populateSucursalFilter(branches) {
        // Save current selection
        const currentValue = sucursalFilterSelect.value;
        
        sucursalFilterSelect.innerHTML = '<option value="">Todas las Sucursales</option>';
        branches.forEach(branch => {
            const option = document.createElement('option');
            option.value = branch.id;
            option.textContent = branch.name;
            sucursalFilterSelect.appendChild(option);
        });
        
        // Restore previous selection if it exists
        if (currentValue) {
            sucursalFilterSelect.value = currentValue;
        }
    }

    async function applyFilters() {
        const filters = {};
        
        if (startDateInput.value) {
            filters.start_date = startDateInput.value;
        }
        if (endDateInput.value) {
            filters.end_date = endDateInput.value;
        }
        if (sucursalFilterSelect.value) {
            filters.branch_id = sucursalFilterSelect.value;
        }
        
        // Reset to page 1 when applying filters
        await loadData(1, filters);
    }

    async function clearFilters() {
        startDateInput.value = '';
        endDateInput.value = '';
        sucursalFilterSelect.value = '';
        // Reset filters and reload from page 1
        await loadData(1, {});
    }

    async function downloadExcel() {
        if (currentFilteredAndRenderedRows.length === 0) {
            alert("No hay datos para descargar.");
            return;
        }
        try {
            const blob = await egresosAPI.downloadEgresos(currentFilteredAndRenderedRows);
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'reporte_egresos_formateado.xlsx';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();

        } catch (error) {
            console.error('Error en la descarga:', error);
            alert(`No se pudo descargar el archivo: ${error.message}`);
        }
    }

    applyFiltersBtn.addEventListener('click', applyFilters);
    clearFiltersBtn.addEventListener('click', clearFilters);
    downloadExcelBtn.addEventListener('click', downloadExcel);
    
    </script>
</body>
</html>
