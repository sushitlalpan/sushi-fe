<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Panel Profesional - Nómina</title>
    <style>
        :root {
            --white: #ffffff;
            --black: #111;
            --blue: #3498db;
            --dark-blue: #2980b9;
            --green: #2ecc71;
            --purple: #9b59b6;
            --orange: #e67e22;
            --red: #e74c3c;
            --yellow: #f1c40f;
            --light-gray: #f9f9f9;
            --box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--light-gray);
            color: var(--black);
            line-height: 1.6;
        }
        header {
            background: linear-gradient(to right, var(--blue), var(--dark-blue));
            color: white;
            padding: 30px 20px;
            text-align: center;
        }
        h1 {
            font-size: 28px;
            margin: 0;
        }
        .filters {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            padding: 20px;
            background: var(--white);
            box-shadow: var(--box-shadow);
            border-radius: var(--border-radius);
            margin: 20px;
        }
        .filters select,
        .filters input[type="date"] {
            padding: 10px;
            font-size: 16px;
            border-radius: 6px;
            border: 1px solid #ccc;
            min-width: 180px;
        }
        .chart-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            padding: 20px;
        }
        .chart-box {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 30px;
        }
        canvas {
            max-width: 100%;
            height: 400px !important;
        }
        .chart-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--blue);
            text-align: center;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
</head>
<body>

    <main id="main-content">
        <header>
            <h1>Panel Profesional - Nómina</h1>
        </header>
        <div class="filters">
            <select id="filtroSucursal">
                <option value="all">Cargando sucursales...</option>
            </select>
            <input type="date" id="fechaInicio" />
            <input type="date" id="fechaFin" />
        </div>
        <div class="chart-container">
            <div class="chart-box">
                <div class="chart-title">Top 10 Colaboradores por Costo en Nómina</div>
                <canvas id="topColaboradores"></canvas>
            </div>
            <div class="chart-box">
                <div class="chart-title">Promedio de Nómina por Colaborador por Sucursal</div>
                <canvas id="promedioPorSucursal"></canvas>
            </div>
            <div class="chart-box">
                <div class="chart-title">Nómina Mensual Acumulada</div>
                <canvas id="nominasMensuales"></canvas>
            </div>
            <div class="chart-box">
                <div class="chart-title">Días Laborados por Semana</div>
                <canvas id="diasLaboradosSemanal"></canvas>
            </div>
            <div class="chart-box">
                <div class="chart-title">Distribución por Tipo de Nómina</div>
                <canvas id="tipoNominaDonut"></canvas>
            </div>
            <div class="chart-box">
                <div class="chart-title">Distribución de Nómina por Sucursal</div>
                <canvas id="nominasPorSucursalDonut"></canvas>
            </div>
        </div>
    </main>
    <script src="env.js"></script>
    <script>
        const backendApiBaseUrl = window.env.API_URL;
        const nominaUrl = `${backendApiBaseUrl}/nomina/list`;
        const sucursalesUrl = `${backendApiBaseUrl}/branches`;

        let originalData = [];
        let charts = {};

        // Registrar plugins de Chart.js una sola vez
        Chart.register(ChartDataLabels);

        document.addEventListener("DOMContentLoaded", function() {
            initializeDashboard();
        });

        async function initializeDashboard() {
            await populateSucursalFilter();
            await loadNominaData();

            document.querySelectorAll('.filters input, .filters select').forEach(el => {
                el.addEventListener('change', () => renderCharts(filterData()));
            });
        }

        async function loadNominaData() {
            try {
                const response = await fetch(nominaUrl, { headers: { 'ngrok-skip-browser-warning': 'true' } });
                const data = await response.json();
                const registros = data.registros || [];

                // Mapear los datos del backend al formato que esperan las gráficas
                originalData = registros.map(item => ({
                    fecha: item.FECHA ? new Date(item.FECHA + 'T00:00:00') : null,
                    colaborador: item.OPERADOR,
                    diasLaborados: parseInt(item.DIAS_LABORADOS) || 0,
                    sucursal: item.SUCURSAL,
                    nomina: parseFloat(item.CANTIDAD) || 0, // 'CANTIDAD' es el costo de la nómina
                    tipoNomina: item.TIPO_NOMINA
                }));
                
                renderCharts(originalData);
            } catch (error) {
                console.error('Error al cargar datos de nómina:', error);
                alert('Error al cargar los datos de nómina.');
            }
        }

        async function populateSucursalFilter() {
            try {
                const response = await fetch(sucursalesUrl, { headers: { 'ngrok-skip-browser-warning': 'true' } });
                const data = await response.json();
                const sucursales = data.branches || [];
                const select = document.getElementById('filtroSucursal');
                select.innerHTML = '<option value="all">Todas las Sucursales</option>';
                sucursales.sort().forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s;
                    opt.textContent = s;
                    select.appendChild(opt);
                });
            } catch (error) {
                console.error('Error al cargar sucursales:', error);
                document.getElementById('filtroSucursal').innerHTML = '<option value="all">Error al cargar</option>';
            }
        }

        function filterData() {
            const sucursal = document.getElementById('filtroSucursal').value;
            const fechaInicioStr = document.getElementById('fechaInicio').value;
            const fechaFinStr = document.getElementById('fechaFin').value;
            
            const start = fechaInicioStr ? new Date(fechaInicioStr + 'T00:00:00') : null;
            const end = fechaFinStr ? new Date(fechaFinStr + 'T00:00:00') : null;
            
            return originalData.filter(item => {
                if (!item.fecha || isNaN(item.fecha)) return false;
                if (sucursal !== 'all' && item.sucursal !== sucursal) return false;
                if (start && item.fecha < start) return false;
                if (end && item.fecha > end) return false;
                return true;
            });
        }
        
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function renderCharts(data) {
            Object.values(charts).forEach(chart => {
                if(chart) chart.destroy();
            });

            const byColaborador = data.reduce((acc, { colaborador, nomina }) => {
                if (colaborador) acc[colaborador] = (acc[colaborador] || 0) + nomina;
                return acc;
            }, {});
            const topColaboradores = Object.entries(byColaborador).sort(([,a],[,b]) => b-a).slice(0, 10);
            
            const bySucursal = data.reduce((acc, { sucursal, nomina }) => {
                if (sucursal) {
                    if (!acc[sucursal]) acc[sucursal] = { total: 0, count: 0 };
                    acc[sucursal].total += nomina;
                    acc[sucursal].count++;
                }
                return acc;
            }, {});
            const labelsSucursal = Object.keys(bySucursal);

            const monthly = data.reduce((acc, { fecha, nomina }) => {
                if (fecha) {
                    const key = `${fecha.getFullYear()}-${String(fecha.getMonth()+1).padStart(2,'0')}`;
                    acc[key] = (acc[key] || 0) + nomina;
                }
                return acc;
            }, {});
            const months = Object.keys(monthly).sort();
            
            const weekly = data.reduce((acc, { fecha, diasLaborados }) => {
                if (fecha) {
                    const key = `Semana ${getWeekNumber(fecha)}`;
                    acc[key] = (acc[key] || 0) + diasLaborados;
                }
                return acc;
            }, {});
            const weeks = Object.keys(weekly).sort((a,b) => parseInt(a.split(' ')[1]) - parseInt(b.split(' ')[1]));
            
            const byTipoNomina = data.reduce((acc, { tipoNomina, nomina }) => {
                if (tipoNomina) acc[tipoNomina] = (acc[tipoNomina] || 0) + nomina;
                return acc;
            }, {});

            const tooltipCurrency = { plugins: { tooltip: { callbacks: { label: ctx => `$${ctx.parsed.toLocaleString('es-MX', {minimumFractionDigits: 2})}` } } } };
            const chartColors = ['#e94a7e', '#f0d44c', '#41c5d3', '#9b59b6', '#3498db', '#e67e22', '#2ecc71'];

            charts.topColaboradores = new Chart('topColaboradores', { type: 'bar', data: { labels: topColaboradores.map(([name]) => name), datasets: [{ label: 'Total Nómina', data: topColaboradores.map(([, val]) => val), backgroundColor: '#e94a7e' }] }, options: tooltipCurrency });
            charts.promedioPorSucursal = new Chart('promedioPorSucursal', { type: 'bar', data: { labels: labelsSucursal, datasets: [{ label: 'Promedio de Nómina', data: labelsSucursal.map(s => bySucursal[s].total / bySucursal[s].count), backgroundColor: '#f0d44c' }] }, options: tooltipCurrency });
            charts.nominasMensuales = new Chart('nominasMensuales', { type: 'line', data: { labels: months, datasets: [{ label: 'Nómina Mensual', data: months.map(m => monthly[m]), borderColor: '#41c5d3', backgroundColor: 'rgba(65, 197, 211, 0.2)', fill: true, tension: 0.3 }] }, options: tooltipCurrency });
            charts.diasLaboradosSemanal = new Chart('diasLaboradosSemanal', { type: 'bar', data: { labels: weeks, datasets: [{ label: 'Días Laborados', data: weeks.map(w => weekly[w]), backgroundColor: '#2ecc71' }] }, options: { plugins: { tooltip: { callbacks: { label: ctx => `${ctx.parsed} días` } } } } });
            charts.tipoNominaDonut = new Chart('tipoNominaDonut', { type: 'doughnut', data: { labels: Object.keys(byTipoNomina), datasets: [{ data: Object.values(byTipoNomina), backgroundColor: ['#e94a7e', '#3498db', '#9b59b6'] }] }, options: { plugins: { tooltip: { callbacks: { label: ctx => `${ctx.label}: $${ctx.parsed.toLocaleString('es-MX')}` } } } } });
            charts.nominasPorSucursalDonut = new Chart('nominasPorSucursalDonut', { type: 'pie', data: { labels: labelsSucursal, datasets: [{ data: labelsSucursal.map(s => bySucursal[s].total), backgroundColor: chartColors }] }, options: { plugins: { tooltip: { callbacks: { label: ctx => `${ctx.label}: $${ctx.parsed.toLocaleString('es-MX')}` } } } } });
        }
    </script>
</body>
</html>