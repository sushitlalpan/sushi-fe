<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	<title>Panel Profesional - Ventas</title>
	<link rel="icon" href="assets/favicon.ico" type="image/x-icon">

	<link rel="stylesheet" href="css/grafica-ventas.css">
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <main id="main-content">
        <header>
            <h1>Panel Profesional - Análisis de Ventas</h1>
        </header>
        <div class="filters">
            <select id="filtroSucursal"><option value="all">Cargando sucursales...</option></select>
            <input type="date" id="fechaInicio" />
            <input type="date" id="fechaFin" />
        </div>
        <div class="chart-container">
            <div class="chart-box"><div class="chart-title">Ventas Diarias</div><canvas id="ventasDiarias"></canvas></div>
            <div class="chart-box"><div class="chart-title">Ticket Promedio por Día</div><canvas id="ticketPromedioSemanal"></canvas></div>
            <div class="chart-box"><div class="chart-title">Ventas Acumuladas Mensuales</div><canvas id="ventasMensuales"></canvas></div>
            <div class="chart-box"><div class="chart-title">Efectivo vs Tarjeta (Diario)</div><canvas id="efectivoVsTarjetaDiario"></canvas></div>
            <div class="chart-box"><div class="chart-title">Ventas por Día de la Semana</div><canvas id="ventasPorDiaSemana"></canvas></div>
            <div class="chart-box"><div class="chart-title">Distribución de Ventas por Sucursal</div><canvas id="ventasPorSucursalDonut"></canvas></div>
        </div>
    </main>
	<script src="js/api-client.js"></script>
	<script src="js/auth-guard.js"></script>
	<script src="js/branches.js"></script>
	<script src="js/sales.js"></script>
	<script>
		let originalData = [];
		let currentFilters = {};

        document.addEventListener("DOMContentLoaded", function() {
            initializeDashboard();
        });

        async function initializeDashboard() {
            await populateSucursalFilter();
            await loadSalesData();
            document.querySelectorAll('.filters input, .filters select').forEach(el => {
                el.addEventListener('change', () => applyFilters());
            });
        }
		
		function parseNumber(value) {
			return parseFloat(String(value).replace(/[^0-9.-]/g, '')) || 0;
		}

		async function loadSalesData(filters = null) {
		    try {
		        // Use provided filters or keep current filters
		        if (filters !== null) {
		            currentFilters = filters;
		        }
		        
		        const data = await salesAPI.getSalesList(0, currentFilters);
		        const records = data.sales || [];
		        
		        originalData = records.map((record, index) => {
		            try {
		                const fecha = new Date(record.closure_date + 'T00:00:00');
		                if (isNaN(fecha.getTime())) {
		                    return null;
		                }
		                return {
		                    sucursal: record.branch_name || 'N/A',
		                    branchId: record.branch_id,
		                    fecha: fecha,
		                    ventasTotales: parseNumber(record.sales_total),
		                    totalEfectivoReal: parseNumber(record.cash_total),
		                    ticketPromedio: parseNumber(record.avg_sale),
		                    totalTarjetaReal: parseNumber(record.card_total),
		                    transfer: parseNumber(record.transfer_amt),
		                    comisionKiwi: parseNumber(record.kiwi_fee_total),
		                    ticketCount: parseNumber(record.payments_nbr || 1)
		                };
		            } catch (e) {
		                console.error(`Error procesando el registro #${index+1}:`, record, e);
		                return null;
		            }
		        }).filter(Boolean);

		        renderCharts(originalData);

		    } catch (error) {
		        console.error('Error al cargar los datos de ventas:', error);
		        alert(`Error al cargar los datos: ${error.message}`);
		    }
		}

		async function populateSucursalFilter() {
			try {
				const data = await branchesAPI.getBranches();
				const select = document.getElementById('filtroSucursal');

				if (data.branches && data.branches.length > 0) {
					select.innerHTML = '<option value="all">Todas las Sucursales</option>';
					
					// Sort branches by name
					const sortedBranches = data.branches.sort((a, b) => {
						const nameA = typeof a === 'string' ? a : (a.name || 'N/A');
						const nameB = typeof b === 'string' ? b : (b.name || 'N/A');
						return nameA.localeCompare(nameB);
					});
					
					sortedBranches.forEach(branch => {
						const branchName = typeof branch === 'string' ? branch : (branch.name || 'N/A');
						const branchId = typeof branch === 'string' ? branch : (branch.id || branchName);
						select.innerHTML += `<option value="${branchId}">${branchName}</option>`;
					});
				} else {
					select.innerHTML = '<option value="all">No hay sucursales</option>';
				}
			} catch (error) {
				console.error('Error al cargar sucursales:', error);
				document.getElementById('filtroSucursal').innerHTML = '<option value="all">Error al cargar</option>';
			}
		}

		async function applyFilters() {
			const filters = {};
			
			const sucursal = document.getElementById('filtroSucursal').value;
			const fechaInicio = document.getElementById('fechaInicio').value;
			const fechaFin = document.getElementById('fechaFin').value;
			
			if (sucursal && sucursal !== 'all') {
				filters.branch_id = sucursal;
			}
			if (fechaInicio) {
				filters.start_date = fechaInicio;
			}
			if (fechaFin) {
				filters.end_date = fechaFin;
			}
			
			await loadSalesData(filters);
		}

		function groupByDate(data, interval = 'day') {
			return data.reduce((acc, item) => {
				let key = '';
				switch(interval) {
					case 'day': key = item.fecha.toISOString().split('T')[0]; break;
					case 'month': key = `${item.fecha.getFullYear()}-${String(item.fecha.getMonth()+1).padStart(2,'0')}`; break;
					case 'weekday':
						const days = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
						key = days[item.fecha.getDay()];
						break;
				}
				acc[key] = acc[key] || { ventas: 0, ticketSuma: 0, ticketCount: 0, efectivo: 0, tarjeta: 0 };
				acc[key].ventas += item.ventasTotales;
				acc[key].ticketSuma += item.ticketPromedio;
				acc[key].ticketCount += item.ticketCount > 0 ? 1 : (item.ticketPromedio > 0 ? 1 : 0);
				acc[key].efectivo += item.totalEfectivoReal;
				acc[key].tarjeta += item.totalTarjetaReal;
				return acc;
			}, {});
		}

		function groupBySucursal(data) {
			return data.reduce((acc, item) => {
				acc[item.sucursal] = (acc[item.sucursal] || 0) + item.ventasTotales;
				return acc;
			}, {});
		}

		function renderCharts(data) {
			const chartIds = ['ventasDiarias', 'ticketPromedioSemanal', 'ventasMensuales', 'efectivoVsTarjetaDiario', 'ventasPorDiaSemana', 'ventasPorSucursalDonut'];
			chartIds.forEach(id => {
				const chart = Chart.getChart(id);
				if (chart) chart.destroy();
			});

			const daily = groupByDate(data, 'day');
			const dates = Object.keys(daily).sort();
			const dailySales = dates.map(d => daily[d].ventas);
			const dailyTicketAverage = dates.map(d => daily[d].ticketCount > 0 ? (daily[d].ticketSuma / daily[d].ticketCount) : 0);
			const dailyCash = dates.map(d => daily[d].efectivo);
			const dailyCard = dates.map(d => daily[d].tarjeta);
			
			const monthly = groupByDate(data, 'month');
			const months = Object.keys(monthly).sort();
			const monthlySales = months.map(m => monthly[m].ventas);
			
			const weekday = groupByDate(data, 'weekday');
			const daysOfWeek = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
			const salesByDay = daysOfWeek.map(day => weekday[day]?.ventas || 0);
			
			const bySucursal = groupBySucursal(data);
            const sucursalLabels = Object.keys(bySucursal);
            const sucursalData = Object.values(bySucursal);
			
			const tooltipCallback = { plugins: { tooltip: { callbacks: { label: ctx => `$${ctx.parsed.y.toLocaleString('es-MX', {minimumFractionDigits: 2})}` } } } };
            const tooltipDoughnut = { plugins: { tooltip: { callbacks: { label: ctx => `${ctx.label}: $${ctx.parsed.toLocaleString('es-MX')}` } } } };

			new Chart('ventasDiarias', { type: 'line', data: { labels: dates, datasets: [{ label: 'Ventas Diarias', data: dailySales, borderColor: '#e94a7e', backgroundColor: 'rgba(233, 74, 126, 0.2)', fill: true, tension: 0.3 }] }, options: tooltipCallback });
			new Chart('ticketPromedioSemanal', { type: 'bar', data: { labels: dates, datasets: [{ label: 'Ticket Promedio por Día', data: dailyTicketAverage, backgroundColor: '#f0d44c' }] }, options: tooltipCallback });
			new Chart('ventasMensuales', { type: 'line', data: { labels: months, datasets: [{ label: 'Ventas Mensuales', data: monthlySales, borderColor: '#41c5d3', backgroundColor: 'rgba(65, 197, 211, 0.2)', fill: true, tension: 0.3 }] }, options: tooltipCallback });
			new Chart('efectivoVsTarjetaDiario', { type: 'bar', data: { labels: dates, datasets: [{ label: 'Efectivo', data: dailyCash, backgroundColor: '#2ecc71' }, { label: 'Tarjeta', data: dailyCard, backgroundColor: '#9b59b6' }] }, options: { ...tooltipCallback, scales: { x: { stacked: true }, y: { stacked: true } } } });
			new Chart('ventasPorDiaSemana', { type: 'radar', data: { labels: daysOfWeek, datasets: [{ label: 'Ventas por Día', data: salesByDay, borderColor: '#3498db', backgroundColor: 'rgba(52, 152, 219, 0.3)' }] }, options: tooltipCallback });
			new Chart('ventasPorSucursalDonut', { type: 'doughnut', data: { labels: sucursalLabels, datasets: [{ data: sucursalData, backgroundColor: ['#e94a7e', '#f0d44c', '#41c5d3', '#9b59b6', '#3498db', '#e67e22', '#2ecc71'] }] }, options: tooltipDoughnut });
		}
	</script>
</body>
</html>