<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel Integrado - Ventas, Egresos, Nómina</title>
  <link rel="stylesheet" href="css/grafica-general.css">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

  <main id="main-content">
    <header>
      <h1>Panel Único - Ventas, Egresos, Nómina</h1>
    </header>

    <div class="filters">
      <select id="filtroSucursal">
        <option value="all">Todas las Sucursales</option>
      </select>
      <input type="date" id="fechaInicio" placeholder="Fecha inicio" />
      <input type="date" id="fechaFin" placeholder="Fecha fin" />
    </div>

    <div class="chart-wrapper">
      <canvas id="graficaUnificada"></canvas>
    </div>

    <div class="stats-container">
      <div class="stat-card">
        <div class="stat-title">Total Ventas</div>
        <div class="stat-value" id="totalVentas">$0.00</div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Total Egresos</div>
        <div class="stat-value" id="totalEgresos">$0.00</div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Total Nómina</div>
        <div class="stat-value" id="totalNomina">$0.00</div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Margen Neto</div>
        <div class="stat-value" id="margenNeto">$0.00</div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Porcentaje de Egresos s/ Ventas</div>
        <div class="stat-value" id="porcentajeEgresos">0%</div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Porcentaje de Nómina s/ Ventas</div>
        <div class="stat-value" id="porcentajeNomina">0%</div>
      </div>
    </div>
  </main>
  <script src="js/env.js"></script>
  <script src="js/api-client.js"></script>
  <script src="js/branches.js"></script>
  <script src="js/datos.js"></script>
  <script>
    let ventasData = [], egresosData = [], nominaData = [];
    let chartInstance = null;

    document.addEventListener("DOMContentLoaded", function () {
      // Set current month as default date range
      const now = new Date();
      const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      
      document.getElementById('fechaInicio').value = firstDayOfMonth.toISOString().split('T')[0];
      document.getElementById('fechaFin').value = lastDayOfMonth.toISOString().split('T')[0];
      
      initializeDashboard();
    });

    async function initializeDashboard() {
      // Get current date range values
      const startDate = document.getElementById('fechaInicio').value;
      const endDate = document.getElementById('fechaFin').value;
      
      // Usar Promise.all para cargar los datos generales y las sucursales en paralelo
      try {
        const [datosGenerales, datosSucursales] = await Promise.all([
          datosAPI.getDatosGenerales(startDate, endDate),
          branchesAPI.getBranches()
        ]);

        // Mapear los datos del nuevo formato de respuesta
        ventasData = (datosGenerales.sales_records || []).map(item => ({
          fecha: item.closure_date ? new Date(item.closure_date + 'T00:00:00') : null,
          sucursal: item.branch_name || 'N/A',
          branchId: item.branch_id,
          total: parseFloat(item.sales_total) || 0
        })).filter(item => item.fecha && !isNaN(item.fecha));

        egresosData = (datosGenerales.expense_records || []).map(item => ({
          fecha: item.expense_date ? new Date(item.expense_date + 'T00:00:00') : null,
          sucursal: item.branch_name || 'N/A',
          branchId: item.branch_id,
          total: parseFloat(item.total_amount) || 0
        })).filter(item => item.fecha && !isNaN(item.fecha));

        nominaData = (datosGenerales.payroll_records || []).map(item => ({
          fecha: item.date ? new Date(item.date) : null,
          sucursal: item.branch_name || 'N/A',
          branchId: item.branch_id,
          total: parseFloat(item.amount) || 0
        })).filter(item => item.fecha && !isNaN(item.fecha));

        // Update summary statistics
        if (datosGenerales.summary) {
          updateSummaryStats(datosGenerales.summary);
        }

        populateSucursales(datosSucursales.branches || []);

      } catch (error) {
        console.error("Error al cargar los datos iniciales:", error);
        alert("No se pudieron cargar los datos del servidor. Por favor, revisa la consola.");
      }
    }

    function populateSucursales(sucursales) {
      const select = document.getElementById('filtroSucursal');
      select.innerHTML = '<option value="all">Todas las Sucursales</option>';
      
      // Sort branches by name
      const sortedBranches = sucursales.sort((a, b) => {
        const nameA = typeof a === 'string' ? a : (a.name || 'N/A');
        const nameB = typeof b === 'string' ? b : (b.name || 'N/A');
        return nameA.localeCompare(nameB);
      });
      
      sortedBranches.forEach(branch => {
        const branchName = typeof branch === 'string' ? branch : (branch.name || 'N/A');
        const branchId = typeof branch === 'string' ? branch : (branch.id || branchName);
        const opt = document.createElement('option');
        opt.value = branchId;
        opt.textContent = branchName;
        select.appendChild(opt);
      });

      // Añadir listeners y dibujar la gráfica después de que todo esté cargado
      document.getElementById('filtroSucursal').addEventListener('change', updateChart);
      document.getElementById('fechaInicio').addEventListener('change', updateChart);
      document.getElementById('fechaFin').addEventListener('change', updateChart);
      updateChart();
    }

    function updateSummaryStats(summary) {
      document.getElementById('totalVentas').textContent = `$${parseFloat(summary.total_sales || 0).toLocaleString('es-MX', {minimumFractionDigits: 2})}`;
      document.getElementById('totalEgresos').textContent = `$${parseFloat(summary.total_expenses || 0).toLocaleString('es-MX', {minimumFractionDigits: 2})}`;
      document.getElementById('totalNomina').textContent = `$${parseFloat(summary.total_payroll || 0).toLocaleString('es-MX', {minimumFractionDigits: 2})}`;
      document.getElementById('margenNeto').textContent = `$${parseFloat(summary.net_profit || 0).toLocaleString('es-MX', {minimumFractionDigits: 2})}`;
      
      const totalSales = parseFloat(summary.total_sales || 0);
      const totalExpenses = parseFloat(summary.total_expenses || 0);
      const totalPayroll = parseFloat(summary.total_payroll || 0);
      
      const expensePercentage = totalSales > 0 ? ((totalExpenses / totalSales) * 100).toFixed(1) : 0;
      const payrollPercentage = totalSales > 0 ? ((totalPayroll / totalSales) * 100).toFixed(1) : 0;
      
      document.getElementById('porcentajeEgresos').textContent = `${expensePercentage}%`;
      document.getElementById('porcentajeNomina').textContent = `${payrollPercentage}%`;
    }

    function filterData(data, sucursal, startDate, endDate) {
      const start = startDate ? new Date(startDate + 'T00:00:00') : null;
      const end = endDate ? new Date(endDate + 'T00:00:00') : null;

      return data.filter(item => {
        if (!item.fecha || isNaN(item.fecha)) return false;
        if (sucursal !== 'all' && item.branchId !== sucursal) return false;
        if (start && item.fecha < start) return false;
        if (end && item.fecha > end) return false;
        return true;
      });
    }

    function groupByDay(data) {
      return data.reduce((acc, item) => {
        const key = item.fecha.toISOString().split('T')[0];
        acc[key] = (acc[key] || 0) + item.total;
        return acc;
      }, {});
    }

    async function updateChart() {
      const sucursal = document.getElementById('filtroSucursal').value;
      const fechaInicio = document.getElementById('fechaInicio').value;
      const fechaFin = document.getElementById('fechaFin').value;
      
      // Reload data when date range changes
      try {
        const datosGenerales = await datosAPI.getDatosGenerales(fechaInicio, fechaFin);
        
        // Update data with new API response
        ventasData = (datosGenerales.sales_records || []).map(item => ({
          fecha: item.closure_date ? new Date(item.closure_date + 'T00:00:00') : null,
          sucursal: item.branch_name || 'N/A',
          branchId: item.branch_id,
          total: parseFloat(item.sales_total) || 0
        })).filter(item => item.fecha && !isNaN(item.fecha));

        egresosData = (datosGenerales.expense_records || []).map(item => ({
          fecha: item.expense_date ? new Date(item.expense_date + 'T00:00:00') : null,
          sucursal: item.branch_name || 'N/A',
          branchId: item.branch_id,
          total: parseFloat(item.total_amount) || 0
        })).filter(item => item.fecha && !isNaN(item.fecha));

        nominaData = (datosGenerales.payroll_records || []).map(item => ({
          fecha: item.date ? new Date(item.date) : null,
          sucursal: item.branch_name || 'N/A',
          branchId: item.branch_id,
          total: parseFloat(item.amount) || 0
        })).filter(item => item.fecha && !isNaN(item.fecha));

        // Update summary statistics
        if (datosGenerales.summary) {
          updateSummaryStats(datosGenerales.summary);
        }
      } catch (error) {
        console.error('Error al actualizar datos:', error);
      }

      const filteredVentas = filterData(ventasData, sucursal, fechaInicio, fechaFin);
      const filteredEgresos = filterData(egresosData, sucursal, fechaInicio, fechaFin);
      const filteredNomina = filterData(nominaData, sucursal, fechaInicio, fechaFin);

      const ventasGrouped = groupByDay(filteredVentas);
      const egresosGrouped = groupByDay(filteredEgresos);
      const nominaGrouped = groupByDay(filteredNomina);

      const allDates = [...new Set([...Object.keys(ventasGrouped), ...Object.keys(egresosGrouped), ...Object.keys(nominaGrouped)].sort())];

      const ventasValues = allDates.map(d => ventasGrouped[d] || 0);
      const egresosValues = allDates.map(d => egresosGrouped[d] || 0);
      const nominaValues = allDates.map(d => nominaGrouped[d] || 0);

      const totalVentas = ventasValues.reduce((a, b) => a + b, 0);
      const totalEgresos = egresosValues.reduce((a, b) => a + b, 0);
      const totalNomina = nominaValues.reduce((a, b) => a + b, 0);
      const margenNeto = totalVentas - totalEgresos - totalNomina;

      const formatCurrency = (value) => `$${value.toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

      document.getElementById('totalVentas').textContent = formatCurrency(totalVentas);
      document.getElementById('totalEgresos').textContent = formatCurrency(totalEgresos);
      document.getElementById('totalNomina').textContent = formatCurrency(totalNomina);
      document.getElementById('margenNeto').textContent = formatCurrency(margenNeto);
      document.getElementById('porcentajeEgresos').textContent = totalVentas > 0 ? `${((totalEgresos / totalVentas) * 100).toFixed(1)}%` : '0%';
      document.getElementById('porcentajeNomina').textContent = totalVentas > 0 ? `${((totalNomina / totalVentas) * 100).toFixed(1)}%` : '0%';

      if (chartInstance) chartInstance.destroy();

      chartInstance = new Chart(document.getElementById('graficaUnificada'), {
        type: 'line',
        data: {
          labels: allDates.map(d => new Date(d + 'T00:00:00').toLocaleDateString('es-MX', { day: '2-digit', month: 'short' })),
          datasets: [
            { label: 'Ventas', data: ventasValues, borderColor: '#2ecc71', backgroundColor: 'rgba(46, 204, 113, 0.1)', tension: 0.3, fill: true },
            { label: 'Egresos', data: egresosValues, borderColor: '#e74c3c', backgroundColor: 'rgba(231, 76, 60, 0.1)', tension: 0.3, fill: true },
            { label: 'Nómina', data: nominaValues, borderColor: '#9b59b6', backgroundColor: 'rgba(155, 89, 182, 0.1)', tension: 0.3, fill: true }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' },
            tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${formatCurrency(ctx.parsed.y)}` } }
          }
        }
      });
    }
  </script>

</body>

</html>