<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Panel Profesional - Egresos</title>
    <style>
        :root {
            --white: #ffffff;
            --black: #111;
            --blue: #3498db;
            --dark-blue: #2980b9;
            --green: #2ecc71;
            --purple: #9b59b6;
            --orange: #e67e22;
            --red: #e74c3c;
            --yellow: #f1c40f;
            --light-gray: #f9f9f9;
            --box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--light-gray);
            color: var(--black);
            line-height: 1.6;
        }
        header {
            background: linear-gradient(to right, var(--blue), var(--dark-blue));
            color: white;
            padding: 30px 20px;
            text-align: center;
        }
        h1 {
            font-size: 28px;
            margin: 0;
        }
        .filters {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            padding: 20px;
            background: var(--white);
            box-shadow: var(--box-shadow);
            border-radius: var(--border-radius);
            margin: 20px;
        }
        .filters select,
        .filters input[type="date"] {
            padding: 10px;
            font-size: 16px;
            border-radius: 6px;
            border: 1px solid #ccc;
            min-width: 180px;
        }
        .chart-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            padding: 20px;
        }
        .chart-box {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 30px;
        }
        canvas {
            max-width: 100%;
            height: 350px !important;
        }
        .chart-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--blue);
            text-align: center;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
</head>
<body>
    
    <main id="main-content">
        <header>
            <h1>Panel Profesional - Egresos</h1>
        </header>
        <div class="filters">
            <select id="filtroSucursal">
                <option value="all">Cargando sucursales...</option>
            </select>
            <input type="date" id="fechaInicio" />
            <input type="date" id="fechaFin" />
        </div>
        <div class="chart-container">
            <div class="chart-box">
                <div class="chart-title">Gastos Diarios</div>
                <canvas id="gastosDiariosChart"></canvas>
            </div>
            <div class="chart-box">
                <div class="chart-title">Gastos Acumulados Mensuales</div>
                <canvas id="gastosMensualesChart"></canvas>
            </div>
            <div class="chart-box">
                <div class="chart-title">Distribución de Gastos por Concepto</div>
                <canvas id="gastosPorConceptoChart"></canvas>
            </div>
            <div class="chart-box">
                <div class="chart-title">Distribución de Gastos por Sucursal</div>
                <canvas id="gastosPorSucursalChart"></canvas>
            </div>
        </div>
    </main>

    <script>
        const backendApiBaseUrl = window.env.API_URL;
        const egresosUrl = `${backendApiBaseUrl}/egresos/list`;
        const sucursalesUrl = `${backendApiBaseUrl}/branches`;

        let originalData = [];
        let charts = {};

        // CORRECCIÓN: Registrar los plugins globalmente una sola vez al inicio.
        Chart.register(ChartDataLabels);

        document.addEventListener("DOMContentLoaded", function() {
            initializeDashboard();
        });

        async function initializeDashboard() {
            await populateSucursalFilter();
            await loadEgresosData();

            document.querySelectorAll('.filters input, .filters select').forEach(el => {
                el.addEventListener('change', () => renderCharts(filterData()));
            });
        }
        
        async function populateSucursalFilter() {
            try {
                const response = await fetch(sucursalesUrl, { headers: { 'ngrok-skip-browser-warning': 'true' } });
                const data = await response.json();
                const sucursales = data.branches || [];
                const select = document.getElementById('filtroSucursal');
                select.innerHTML = '<option value="all">Todas las Sucursales</option>';
                sucursales.sort().forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s;
                    opt.textContent = s;
                    select.appendChild(opt);
                });
            } catch (error) {
                console.error('Error al cargar sucursales:', error);
                document.getElementById('filtroSucursal').innerHTML = '<option value="all">Error al cargar</option>';
            }
        }

        async function loadEgresosData() {
            try {
                const response = await fetch(egresosUrl, { headers: { 'ngrok-skip-browser-warning': 'true' } });
                const data = await response.json();
                const registros = data.registros || [];
                
                originalData = registros.map(item => ({
                    fecha: item.FECHA ? new Date(item.FECHA + 'T00:00:00') : null,
                    sucursal: item.SUCURSAL,
                    concepto: item.CONCEPTO,
                    total: parseFloat(item.PRECIO) || 0
                }));

                renderCharts(originalData);
            } catch (error) {
                console.error('Error al cargar datos de egresos:', error);
                alert('Error al cargar los datos de egresos.');
            }
        }

        function filterData() {
            const sucursal = document.getElementById('filtroSucursal').value;
            const fechaInicioStr = document.getElementById('fechaInicio').value;
            const fechaFinStr = document.getElementById('fechaFin').value;

            const fechaInicio = fechaInicioStr ? new Date(fechaInicioStr + 'T00:00:00') : null;
            const fechaFin = fechaFinStr ? new Date(fechaFinStr + 'T00:00:00') : null;

            return originalData.filter(item => {
                if (!item.fecha || isNaN(item.fecha)) return false;
                if (sucursal !== 'all' && item.sucursal !== sucursal) return false;
                if (fechaInicio && item.fecha < fechaInicio) return false;
                if (fechaFin && item.fecha > fechaFin) return false;
                return true;
            });
        }
        
        function renderCharts(data) {
            Object.values(charts).forEach(chart => {
                if(chart) chart.destroy();
            });

            const dailyData = data.reduce((acc, { fecha, total }) => {
                if (fecha) {
                    const key = fecha.toISOString().split('T')[0];
                    acc[key] = (acc[key] || 0) + total;
                }
                return acc;
            }, {});
            const dailyLabels = Object.keys(dailyData).sort();
            const dailyValues = dailyLabels.map(label => dailyData[label]);

            const monthlyData = data.reduce((acc, { fecha, total }) => {
                if (fecha) {
                    const key = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;
                    acc[key] = (acc[key] || 0) + total;
                }
                return acc;
            }, {});
            const monthlyLabels = Object.keys(monthlyData).sort();
            const monthlyValues = monthlyLabels.map(label => monthlyData[label]);

            const byConcepto = data.reduce((acc, { concepto, total }) => {
                if (concepto) {
                    acc[concepto] = (acc[concepto] || 0) + total;
                }
                return acc;
            }, {});
            const labelsConcepto = Object.keys(byConcepto);
            const dataConcepto = Object.values(byConcepto);

            const bySucursal = data.reduce((acc, { sucursal, total }) => {
                if (sucursal) {
                    acc[sucursal] = (acc[sucursal] || 0) + total;
                }
                return acc;
            }, {});
            const labelsSucursal = Object.keys(bySucursal);
            const dataSucursal = Object.values(bySucursal);

            const chartColors = ['#e94a7e', '#f0d44c', '#41c5d3', '#9b59b6', '#3498db', '#e67e22', '#2ecc71', '#e74c3c'];
            const tooltipCurrency = { plugins: { tooltip: { callbacks: { label: ctx => `$${ctx.parsed.toLocaleString('es-MX', {minimumFractionDigits: 2})}` } } } };

            charts.gastosDiarios = new Chart('gastosDiariosChart', {
                type: 'line',
                data: {
                    labels: dailyLabels,
                    datasets: [{ label: 'Gastos', data: dailyValues, borderColor: '#e74c3c', backgroundColor: 'rgba(231, 76, 60, 0.2)', fill: true, tension: 0.3 }]
                },
                options: tooltipCurrency
            });

            charts.gastosMensuales = new Chart('gastosMensualesChart', {
                type: 'bar',
                data: {
                    labels: monthlyLabels,
                    datasets: [{ label: 'Gastos', data: monthlyValues, backgroundColor: '#2ecc71' }]
                },
                options: tooltipCurrency
            });

            charts.gastosPorConcepto = new Chart('gastosPorConceptoChart', {
                type: 'doughnut',
                data: { 
                    labels: labelsConcepto, 
                    // CORRECCIÓN: Se arregló el error de tipeo "Gastros"
                    datasets: [{ label: 'Gastos', data: dataConcepto, backgroundColor: chartColors }] 
                },
                options: { plugins: { legend: { position: 'right' }, ...tooltipCurrency.plugins } }
            });

            charts.gastosPorSucursal = new Chart('gastosPorSucursalChart', {
                type: 'pie',
                data: { 
                    labels: labelsSucursal, 
                    datasets: [{ label: 'Gastos', data: dataSucursal, backgroundColor: chartColors.slice().reverse() }] 
                },
                options: { plugins: { legend: { position: 'right' }, ...tooltipCurrency.plugins } }
            });
        }
    </script>
</body>
</html>