<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel Profesional - Nómina</title>
    <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="css/grafica-nomina.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
</head>

<body>

    <main id="main-content">
        <header>
            <h1>Panel Profesional - Nómina</h1>
        </header>
        <div class="filters">
            <select id="filtroSucursal">
                <option value="all">Cargando sucursales...</option>
            </select>
            <input type="date" id="fechaInicio" />
            <input type="date" id="fechaFin" />
        </div>
        <div class="chart-container">
            <div class="chart-box">
                <div class="chart-title">Top 10 Colaboradores por Costo en Nómina</div>
                <canvas id="topColaboradores"></canvas>
            </div>
            <div class="chart-box">
                <div class="chart-title">Promedio de Nómina por Colaborador por Sucursal</div>
                <canvas id="promedioPorSucursal"></canvas>
            </div>
            <div class="chart-box">
                <div class="chart-title">Nómina Mensual Acumulada</div>
                <canvas id="nominasMensuales"></canvas>
            </div>
            <div class="chart-box">
                <div class="chart-title">Días Laborados por Semana</div>
                <canvas id="diasLaboradosSemanal"></canvas>
            </div>
            <div class="chart-box">
                <div class="chart-title">Distribución por Tipo de Nómina</div>
                <canvas id="tipoNominaDonut"></canvas>
            </div>
            <div class="chart-box">
                <div class="chart-title">Distribución de Nómina por Sucursal</div>
                <canvas id="nominasPorSucursalDonut"></canvas>
            </div>
        </div>
    </main>
    <script src="js/api-client.js"></script>
    <script src="js/auth-guard.js"></script>
    <script src="js/branches.js"></script>
    <script src="js/nomina.js"></script>
    <script>
        let originalData = [];
        let charts = {};
        let currentFilters = {};

        // Registrar plugins de Chart.js una sola vez
        Chart.register(ChartDataLabels);

        document.addEventListener("DOMContentLoaded", function () {
            initializeDashboard();
        });

        async function initializeDashboard() {
            await populateSucursalFilter();
            await loadNominaData();

            document.querySelectorAll('.filters input, .filters select').forEach(el => {
                el.addEventListener('change', () => applyFilters());
            });
        }

        async function loadNominaData(filters = null) {
            try {
                // Use provided filters or keep current filters
                if (filters !== null) {
                    currentFilters = filters;
                }
                
                const data = await nominaAPI.getNominaList(0, currentFilters);
                const payrollRecords = data.payroll_records || [];

                // Mapear los datos del backend al formato que esperan las gráficas
                originalData = payrollRecords.map(item => ({
                    fecha: item.date ? new Date(item.date) : null,
                    colaborador: item.worker_username || 'N/A',
                    diasLaborados: parseInt(item.days_worked) || 0,
                    sucursal: item.branch_name || 'N/A',
                    branchId: item.branch_id,
                    nomina: parseFloat(item.amount) || 0,
                    tipoNomina: item.payroll_type || 'N/A',
                    notas: item.notes || ''
                })).filter(item => item.fecha && !isNaN(item.fecha));

                renderCharts(originalData);
            } catch (error) {
                console.error('Error al cargar datos de nómina:', error);
                alert('Error al cargar los datos de nómina.');
            }
        }

        async function applyFilters() {
            const filters = {};
            
            const sucursal = document.getElementById('filtroSucursal').value;
            const fechaInicioStr = document.getElementById('fechaInicio').value;
            const fechaFinStr = document.getElementById('fechaFin').value;
            
            if (sucursal && sucursal !== 'all') {
                filters.branch_id = sucursal;
            }
            if (fechaInicioStr) {
                filters.start_date = fechaInicioStr;
            }
            if (fechaFinStr) {
                filters.end_date = fechaFinStr;
            }
            
            await loadNominaData(filters);
        }

        async function populateSucursalFilter() {
            try {
                const data = await branchesAPI.getBranches();
                const sucursales = data.branches || [];
                const select = document.getElementById('filtroSucursal');
                select.innerHTML = '<option value="all">Todas las Sucursales</option>';

                // Sort branches by name
                const sortedBranches = sucursales.sort((a, b) => {
                    const nameA = typeof a === 'string' ? a : (a.name || 'N/A');
                    const nameB = typeof b === 'string' ? b : (b.name || 'N/A');
                    return nameA.localeCompare(nameB);
                });

                sortedBranches.forEach(branch => {
                    const branchName = typeof branch === 'string' ? branch : (branch.name || 'N/A');
                    const branchId = typeof branch === 'string' ? branch : (branch.id || branchName);
                    const opt = document.createElement('option');
                    opt.value = branchId;
                    opt.textContent = branchName;
                    select.appendChild(opt);
                });
            } catch (error) {
                console.error('Error al cargar sucursales:', error);
                document.getElementById('filtroSucursal').innerHTML = '<option value="all">Error al cargar</option>';
            }
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function renderCharts(data) {
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });

            const byColaborador = data.reduce((acc, { colaborador, nomina }) => {
                if (colaborador) acc[colaborador] = (acc[colaborador] || 0) + nomina;
                return acc;
            }, {});
            const topColaboradores = Object.entries(byColaborador).sort(([, a], [, b]) => b - a).slice(0, 10);

            const bySucursal = data.reduce((acc, { sucursal, nomina }) => {
                if (sucursal) {
                    if (!acc[sucursal]) acc[sucursal] = { total: 0, count: 0 };
                    acc[sucursal].total += nomina;
                    acc[sucursal].count++;
                }
                return acc;
            }, {});
            const labelsSucursal = Object.keys(bySucursal);

            const monthly = data.reduce((acc, { fecha, nomina }) => {
                if (fecha) {
                    const key = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;
                    acc[key] = (acc[key] || 0) + nomina;
                }
                return acc;
            }, {});
            const months = Object.keys(monthly).sort();

            const weekly = data.reduce((acc, { fecha, diasLaborados }) => {
                if (fecha) {
                    const key = `Semana ${getWeekNumber(fecha)}`;
                    acc[key] = (acc[key] || 0) + diasLaborados;
                }
                return acc;
            }, {});
            const weeks = Object.keys(weekly).sort((a, b) => parseInt(a.split(' ')[1]) - parseInt(b.split(' ')[1]));

            const byTipoNomina = data.reduce((acc, { tipoNomina, nomina }) => {
                if (tipoNomina) acc[tipoNomina] = (acc[tipoNomina] || 0) + nomina;
                return acc;
            }, {});

            const tooltipCurrency = {
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: ctx => {
                                const value = typeof ctx.parsed === 'object' ? (ctx.parsed.y || ctx.parsed) : ctx.parsed;
                                return `$${value.toLocaleString('es-MX', { minimumFractionDigits: 2 })}`;
                            }
                        }
                    }
                }
            };
            const chartColors = ['#e94a7e', '#f0d44c', '#41c5d3', '#9b59b6', '#3498db', '#e67e22', '#2ecc71'];

            charts.topColaboradores = new Chart('topColaboradores', { type: 'bar', data: { labels: topColaboradores.map(([name]) => name), datasets: [{ label: 'Total Nómina', data: topColaboradores.map(([, val]) => val), backgroundColor: '#e94a7e' }] }, options: tooltipCurrency });
            charts.promedioPorSucursal = new Chart('promedioPorSucursal', { type: 'bar', data: { labels: labelsSucursal, datasets: [{ label: 'Promedio de Nómina', data: labelsSucursal.map(s => bySucursal[s].total / bySucursal[s].count), backgroundColor: '#f0d44c' }] }, options: tooltipCurrency });
            charts.nominasMensuales = new Chart('nominasMensuales', { type: 'line', data: { labels: months, datasets: [{ label: 'Nómina Mensual', data: months.map(m => monthly[m]), borderColor: '#41c5d3', backgroundColor: 'rgba(65, 197, 211, 0.2)', fill: true, tension: 0.3 }] }, options: tooltipCurrency });
            charts.diasLaboradosSemanal = new Chart('diasLaboradosSemanal', { type: 'bar', data: { labels: weeks, datasets: [{ label: 'Días Laborados', data: weeks.map(w => weekly[w]), backgroundColor: '#2ecc71' }] }, options: { plugins: { tooltip: { callbacks: { label: ctx => {
                const value = typeof ctx.parsed === 'object' ? (ctx.parsed.y || ctx.parsed) : ctx.parsed;
                return `${value} días`;
            } } } } } });
            charts.tipoNominaDonut = new Chart('tipoNominaDonut', { type: 'doughnut', data: { labels: Object.keys(byTipoNomina), datasets: [{ data: Object.values(byTipoNomina), backgroundColor: ['#e94a7e', '#3498db', '#9b59b6'] }] }, options: { plugins: { tooltip: { callbacks: { label: ctx => `${ctx.label}: $${ctx.parsed.toLocaleString('es-MX')}` } } } } });
            charts.nominasPorSucursalDonut = new Chart('nominasPorSucursalDonut', { type: 'pie', data: { labels: labelsSucursal, datasets: [{ data: labelsSucursal.map(s => bySucursal[s].total), backgroundColor: chartColors }] }, options: { plugins: { tooltip: { callbacks: { label: ctx => `${ctx.label}: $${ctx.parsed.toLocaleString('es-MX')}` } } } } });
        }
    </script>
</body>

</html>