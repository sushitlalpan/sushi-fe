<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel Integrado - Ventas, Egresos, Nómina</title>
  <style>
    :root {
      --white: #ffffff;
      --black: #111;
      --blue: #3498db;
      --dark-blue: #2980b9;
      --green: #2ecc71;
      --red: #e74c3c;
      --purple: #9b59b6;
      --light-gray: #f9f9f9;
      --box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
      --border-radius: 12px;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--light-gray);
      color: var(--black);
      line-height: 1.6;
    }
    main {
      padding: 20px;
    }
    header {
      background: linear-gradient(to right, var(--blue), var(--dark-blue));
      color: white;
      padding: 20px;
      text-align: center;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
    }
    h1 {
      font-size: 28px;
    }
    .filters {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 15px;
      padding: 15px;
      background: var(--white);
      box-shadow: var(--box-shadow);
      border-radius: var(--border-radius);
      margin-bottom: 20px;
    }
    .filters select,
    .filters input[type="date"] {
      padding: 10px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
      min-width: 160px;
    }
    .chart-wrapper {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        padding: 20px;
        margin-bottom: 30px;
    }
    canvas {
      max-width: 100%;
      height: 500px !important;
    }
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      font-size: 16px;
      text-align: center;
    }
    .stat-title {
      font-weight: bold;
      color: var(--blue);
      margin-bottom: 5px;
    }
    .stat-value {
      font-size: 20px;
      font-weight: 600;
      color: var(--black);
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<main id="main-content">
  <header><h1>Panel Único - Ventas, Egresos, Nómina</h1></header>

  <div class="filters">
    <select id="filtroSucursal">
      <option value="all">Todas las Sucursales</option>
    </select>
    <input type="date" id="fechaInicio" placeholder="Fecha inicio" />
    <input type="date" id="fechaFin" placeholder="Fecha fin" />
  </div>
  
  <div class="chart-wrapper">
    <canvas id="graficaUnificada"></canvas>
  </div>

  <div class="stats-container">
    <div class="stat-card">
      <div class="stat-title">Total Ventas</div>
      <div class="stat-value" id="totalVentas">$0.00</div>
    </div>
    <div class="stat-card">
      <div class="stat-title">Total Egresos</div>
      <div class="stat-value" id="totalEgresos">$0.00</div>
    </div>
    <div class="stat-card">
      <div class="stat-title">Total Nómina</div>
      <div class="stat-value" id="totalNomina">$0.00</div>
    </div>
    <div class="stat-card">
      <div class="stat-title">Margen Neto</div>
      <div class="stat-value" id="margenNeto">$0.00</div>
    </div>
    <div class="stat-card">
      <div class="stat-title">Porcentaje de Egresos s/ Ventas</div>
      <div class="stat-value" id="porcentajeEgresos">0%</div>
    </div>
    <div class="stat-card">
      <div class="stat-title">Porcentaje de Nómina s/ Ventas</div>
      <div class="stat-value" id="porcentajeNomina">0%</div>
    </div>
  </div>
</main>

<script>
const backendApiBaseUrl = window.env.API_URL;
const datosGeneralesUrl = `${backendApiBaseUrl}/datos/generales`;
const sucursalesUrl = `${backendApiBaseUrl}/branches`;

let ventasData = [], egresosData = [], nominaData = [];
let chartInstance = null;

document.addEventListener("DOMContentLoaded", function() {
    initializeDashboard();
});

async function initializeDashboard() {
    // Usar Promise.all para cargar los datos generales y las sucursales en paralelo
    try {
        const [datosGeneralesResponse, sucursalesResponse] = await Promise.all([
            fetch(datosGeneralesUrl, { headers: { 'ngrok-skip-browser-warning': 'true' } }),
            fetch(sucursalesUrl, { headers: { 'ngrok-skip-browser-warning': 'true' } })
        ]);

        const datosGenerales = await datosGeneralesResponse.json();
        const datosSucursales = await sucursalesResponse.json();

        // Mapear los datos de cada hoja a un formato unificado
        ventasData = (datosGenerales.ventas || []).map(item => ({
            fecha: item['FECHA DE CORTE'] ? new Date(item['FECHA DE CORTE'] + 'T00:00:00') : null,
            sucursal: item.SUCURSAL,
            total: parseFloat(item['VENTAS TOTALES']) || 0
        }));

        egresosData = (datosGenerales.egresos || []).map(item => ({
            fecha: item.FECHA ? new Date(item.FECHA + 'T00:00:00') : null,
            sucursal: item.SUCURSAL,
            total: parseFloat(item.PRECIO) || 0
        }));

        nominaData = (datosGenerales.nomina || []).map(item => ({
            fecha: item.FECHA ? new Date(item.FECHA + 'T00:00:00') : null,
            sucursal: item.SUCURSAL,
            total: parseFloat(item.CANTIDAD) || 0
        }));
        
        populateSucursales(datosSucursales.branches || []);

    } catch (error) {
        console.error("Error al cargar los datos iniciales:", error);
        alert("No se pudieron cargar los datos del servidor. Por favor, revisa la consola.");
    }
}

function populateSucursales(sucursales) {
    const select = document.getElementById('filtroSucursal');
    select.innerHTML = '<option value="all">Todas las Sucursales</option>';
    sucursales.sort().forEach(s => {
        const opt = document.createElement('option');
        opt.value = s;
        opt.textContent = s;
        select.appendChild(opt);
    });
    
    // Añadir listeners y dibujar la gráfica después de que todo esté cargado
    document.getElementById('filtroSucursal').addEventListener('change', updateChart);
    document.getElementById('fechaInicio').addEventListener('change', updateChart);
    document.getElementById('fechaFin').addEventListener('change', updateChart);
    updateChart();
}

function filterData(data, sucursal, startDate, endDate) {
  const start = startDate ? new Date(startDate + 'T00:00:00') : null;
  const end = endDate ? new Date(endDate + 'T00:00:00') : null;
  
  return data.filter(item => {
    if (!item.fecha || isNaN(item.fecha)) return false;
    if (sucursal !== 'all' && item.sucursal !== sucursal) return false;
    if (start && item.fecha < start) return false;
    if (end && item.fecha > end) return false;
    return true;
  });
}

function groupByDay(data) {
  return data.reduce((acc, item) => {
    const key = item.fecha.toISOString().split('T')[0];
    acc[key] = (acc[key] || 0) + item.total;
    return acc;
  }, {});
}

function updateChart() {
  const sucursal = document.getElementById('filtroSucursal').value;
  const fechaInicio = document.getElementById('fechaInicio').value;
  const fechaFin = document.getElementById('fechaFin').value;

  const filteredVentas = filterData(ventasData, sucursal, fechaInicio, fechaFin);
  const filteredEgresos = filterData(egresosData, sucursal, fechaInicio, fechaFin);
  const filteredNomina = filterData(nominaData, sucursal, fechaInicio, fechaFin);

  const ventasGrouped = groupByDay(filteredVentas);
  const egresosGrouped = groupByDay(filteredEgresos);
  const nominaGrouped = groupByDay(filteredNomina);

  const allDates = [...new Set([...Object.keys(ventasGrouped), ...Object.keys(egresosGrouped), ...Object.keys(nominaGrouped)].sort())];

  const ventasValues = allDates.map(d => ventasGrouped[d] || 0);
  const egresosValues = allDates.map(d => egresosGrouped[d] || 0);
  const nominaValues = allDates.map(d => nominaGrouped[d] || 0);

  const totalVentas = ventasValues.reduce((a, b) => a + b, 0);
  const totalEgresos = egresosValues.reduce((a, b) => a + b, 0);
  const totalNomina = nominaValues.reduce((a, b) => a + b, 0);
  const margenNeto = totalVentas - totalEgresos - totalNomina;
  
  const formatCurrency = (value) => `$${value.toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

  document.getElementById('totalVentas').textContent = formatCurrency(totalVentas);
  document.getElementById('totalEgresos').textContent = formatCurrency(totalEgresos);
  document.getElementById('totalNomina').textContent = formatCurrency(totalNomina);
  document.getElementById('margenNeto').textContent = formatCurrency(margenNeto);
  document.getElementById('porcentajeEgresos').textContent = totalVentas > 0 ? `${((totalEgresos / totalVentas) * 100).toFixed(1)}%` : '0%';
  document.getElementById('porcentajeNomina').textContent = totalVentas > 0 ? `${((totalNomina / totalVentas) * 100).toFixed(1)}%` : '0%';

  if (chartInstance) chartInstance.destroy();

  chartInstance = new Chart(document.getElementById('graficaUnificada'), {
    type: 'line',
    data: {
      labels: allDates.map(d => new Date(d+'T00:00:00').toLocaleDateString('es-MX', {day:'2-digit', month:'short'})),
      datasets: [
        { label: 'Ventas', data: ventasValues, borderColor: '#2ecc71', backgroundColor: 'rgba(46, 204, 113, 0.1)', tension: 0.3, fill: true },
        { label: 'Egresos', data: egresosValues, borderColor: '#e74c3c', backgroundColor: 'rgba(231, 76, 60, 0.1)', tension: 0.3, fill: true },
        { label: 'Nómina', data: nominaValues, borderColor: '#9b59b6', backgroundColor: 'rgba(155, 89, 182, 0.1)', tension: 0.3, fill: true }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { 
          legend: { position: 'top' }, 
          tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${formatCurrency(ctx.parsed.y)}` } } 
      }
    }
  });
}
</script>

</body>
</html>