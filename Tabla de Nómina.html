<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	<title>Panel de Administración - Nómina</title>
	<style>
		:root {
			--white: #ffffff;
			--black: #000000;
			--pink: #e94a7e;
			--yellow: #f0d44c;
			--blue: #41c5d3;
			--gray: #f0f0f0;
			--vivid-green: #7FFF7F;
			--vivid-red: #FF6347;
		}
		body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--gray); }
		header { background-color: var(--blue); color: var(--white); padding: 20px; text-align: center; }
		h1 { margin: 0; font-size: 24px; }
		.table-container { padding: 30px; overflow-x: auto; }
		table { width: 100%; border-collapse: collapse; background-color: white; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); border-radius: 8px; overflow: hidden; }
		thead { background-color: var(--blue); color: white; }
		th, td { padding: 10px 12px; border: 1px solid #ccc; font-size: 14px; text-align: center; vertical-align: middle; }
		tbody tr:nth-child(even) { background-color: #f9f9f9; }
		tbody tr:hover { background-color: #eef8fb; }
		.color-select { width: 100%; padding: 5px; border-radius: 4px; border: 1px solid #ccc; background-color: var(--white); cursor: pointer; }
		tr[data-status="green"] { background-color: var(--vivid-green) !important; }
		tr[data-status="red"] { background-color: var(--vivid-red) !important; }
		tr[data-status="white"] { background-color: var(--white) !important; }
		tr[data-status="white"]:nth-child(even) { background-color: #f9f9f9 !important; }
		tr[data-status="white"]:hover { background-color: #eef8fb !important; }
		.summary-row { font-weight: bold; background-color: #e0e0e0; }
		.summary-row.total { background-color: #c9e6f1; }
		.summary-row.average { background-color: #f0e6c9; }
		.filters-container { padding: 20px 30px; background-color: var(--white); margin: 20px 30px 0; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
		.filter-group { display: flex; flex-direction: column; gap: 5px; }
		.filter-group label { font-size: 14px; font-weight: bold; color: #333; }
		.filters-container input[type="date"], .filters-container select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
		.filters-container button { padding: 10px 15px; background-color: var(--blue); color: var(--white); border: none; border-radius: 4px; cursor: pointer; font-size: 14px; transition: background-color 0.3s ease; }
		.filters-container button:hover { background-color: #31a7b3; }
		.observation-cell { width: 150px; }
		.observation-input { width: calc(100% - 10px); padding: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; box-sizing: border-box; }
	</style>
</head>
<body>
    <main id="main-content">
        <header>
            <h1>Panel de Administración - Nómina</h1>
        </header>

        <div class="filters-container">
            <div class="filter-group">
                <label for="startDate">Fecha de Pago (Desde):</label>
                <input type="date" id="startDate">
            </div>
            <div class="filter-group">
                <label for="endDate">Fecha de Pago (Hasta):</label>
                <input type="date" id="endDate">
            </div>
            <div class="filter-group">
                <label for="sucursalFilter">Filtrar por Sucursal:</label>
                <select id="sucursalFilter">
                    <option value="">Todas las Sucursales</option>
                </select>
            </div>
            <button id="applyFilters">Aplicar Filtros</button>
            <button id="clearFilters">Limpiar Filtros</button>
            <button id="downloadExcelBtn">Descargar Excel Formateado</button>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>FECHA DE PAGO</th>
                        <th>COLABORADOR</th>
                        <th>DÍAS LABORADOS</th>
                        <th>SUCURSAL</th>
                        <th>CANTIDAD</th>
                        <th>NÓMINA</th>
                        <th>NOTAS</th>
                        <th>ESTADO</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </main>

	<script>
    document.addEventListener("DOMContentLoaded", function() {
        loadData();
    });

	const apiUrl = `${window.env.API_URL}/nomina/list`;
    const downloadUrl = `${window.env.API_URL}/nomina/download`;

	const tableBody = document.querySelector('tbody');
	const tableHeaderRow = document.querySelector('thead tr');
	const startDateInput = document.getElementById('startDate');
	const endDateInput = document.getElementById('endDate');
	const sucursalFilterSelect = document.getElementById('sucursalFilter');
	const applyFiltersBtn = document.getElementById('applyFilters');
	const clearFiltersBtn = document.getElementById('clearFilters');
	const downloadExcelBtn = document.getElementById('downloadExcelBtn');

	let allTableRowsData = [];
	let currentFilteredAndRenderedRows = [];
	let currentHeaderColCount = 8;
	const columnsToAggregate = { 'cantidad': 4 };

	function parseNumber(value) {
		if (typeof value === 'string') {
			value = value.replace('$', '').replace(/\./g, '').replace(/,/g, '.');
		}
		const num = parseFloat(value);
		return isNaN(num) ? 0 : num;
	}

    function formatCurrency(value) {
        return value.toLocaleString('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

	function updateTableHeader(showObservationColumn) {
		const observationHeader = document.querySelector('.observation-header');
		if (showObservationColumn && !observationHeader) {
			const newTh = document.createElement('th');
			newTh.textContent = 'OBSERVACIÓN';
			newTh.classList.add('observation-header');
			tableHeaderRow.appendChild(newTh);
			currentHeaderColCount = 9;
		} else if (!showObservationColumn && observationHeader) {
			observationHeader.remove();
			currentHeaderColCount = 8;
		}
	}

    function formatDateForDisplay(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const userTimezoneOffset = date.getTimezoneOffset() * 60000;
        const correctedDate = new Date(date.getTime() + userTimezoneOffset);
        return correctedDate.toLocaleDateString('es-CO', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    function normalizeDate(dateString) {
        if (!dateString) return null;
        const [year, month, day] = dateString.split('-').map(Number);
        return new Date(Date.UTC(year, month - 1, day));
    }

	async function loadData() {
		try {
			const response = await fetch(apiUrl);
			if (!response.ok) throw new Error(`Error de red: ${response.status}`);
			
            const data = await response.json();
            const records = data.registros || [];

			if (records.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="${currentHeaderColCount}" class="no-data-cell">No hay datos para mostrar.</td></tr>`;
				return;
			}
			
            allTableRowsData = records.map((record, index) => ({
                id: index,
                date: record.FECHA || '',
                colaborador: record.OPERADOR || '',
                diasLaborados: record.DIAS_LABORADOS || '',
                sucursal: record.SUCURSAL || '',
                cantidad: record.CANTIDAD || 0,
                nomina: record.TIPO_NOMINA || '',
                notas: record.NOTAS || '',
                status: 'white',
                observation: ''
            }));

            const uniqueSucursales = new Set(allTableRowsData.map(row => row.sucursal).filter(Boolean));
			populateSucursalFilter(uniqueSucursales);
			renderTable(allTableRowsData);

		} catch (error) {
			console.error('Error al cargar los datos:', error);
            tableBody.innerHTML = `<tr><td colspan="${currentHeaderColCount}" class="no-data-cell">Error al cargar datos: ${error.message}</td></tr>`;
		}
	}

	function calculateAndDisplayTotals(data) {
		const existingSummaryRows = tableBody.querySelectorAll('.summary-row');
		existingSummaryRows.forEach(row => row.remove());
		if (data.length === 0) return;

		let totalCantidad = data.reduce((sum, row) => sum + parseNumber(row.cantidad), 0);
		const averageCantidad = data.length > 0 ? totalCantidad / data.length : 0;
		
        const appendCell = (row, content) => {
			const cell = row.insertCell();
			cell.textContent = content;
			return cell;
		};
		
        const totalRow = tableBody.insertRow();
		totalRow.className = 'summary-row total';
		appendCell(totalRow, 'TOTALES').colSpan = 4;
		for (let i = 4; i < currentHeaderColCount; i++) {
			const cell = totalRow.insertCell();
			if (i === columnsToAggregate['cantidad']) cell.textContent = formatCurrency(totalCantidad);
		}
		
        const averageRow = tableBody.insertRow();
		averageRow.className = 'summary-row average';
		appendCell(averageRow, 'PROMEDIOS').colSpan = 4;
		for (let i = 4; i < currentHeaderColCount; i++) {
			const cell = averageRow.insertCell();
			if (i === columnsToAggregate['cantidad']) cell.textContent = formatCurrency(averageCantidad);
		}
	}

	function renderTable(dataToRender) {
		tableBody.innerHTML = '';
		currentFilteredAndRenderedRows = dataToRender;
		const needsObservationColumn = dataToRender.some(row => row.status === 'red');
		updateTableHeader(needsObservationColumn);

		if (dataToRender.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${currentHeaderColCount}" class="no-data-cell">No hay datos que coincidan con los filtros.</td></tr>`;
			return;
		}

		dataToRender.forEach(rowData => {
			const newRow = tableBody.insertRow();
			newRow.dataset.status = rowData.status;
			newRow.dataset.rowId = rowData.id;

			newRow.insertCell().textContent = formatDateForDisplay(rowData.date);
			newRow.insertCell().textContent = rowData.colaborador;
			newRow.insertCell().textContent = rowData.diasLaborados;
			newRow.insertCell().textContent = rowData.sucursal;
			newRow.insertCell().textContent = formatCurrency(parseNumber(rowData.cantidad));
			newRow.insertCell().textContent = rowData.nomina;
			newRow.insertCell().textContent = rowData.notas;

			const statusCell = newRow.insertCell();
			const selectElement = document.createElement('select');
			selectElement.className = 'color-select';
			selectElement.innerHTML = `<option value="white">Blanco</option><option value="green">Verde</option><option value="red">Rojo</option>`;
			selectElement.value = rowData.status;
			statusCell.appendChild(selectElement);

			if (needsObservationColumn) {
				const observationCell = newRow.insertCell();
				observationCell.className = 'observation-cell';
				const observationInput = document.createElement('input');
				observationInput.type = 'text';
				observationInput.className = 'observation-input';
				observationInput.placeholder = 'Escribir observación...';
				observationInput.value = rowData.observation;
				observationInput.addEventListener('input', function() {
					const targetRow = allTableRowsData.find(r => r.id == newRow.dataset.rowId);
					if (targetRow) targetRow.observation = this.value;
				});
				observationCell.appendChild(observationInput);
				observationCell.style.display = (rowData.status === 'red') ? '' : 'none';
			}

			selectElement.addEventListener('change', function() {
				const selectedStatus = this.value;
				const targetRow = allTableRowsData.find(r => r.id == newRow.dataset.rowId);
				if (targetRow) {
                    targetRow.status = selectedStatus;
                    if (selectedStatus !== 'red') {
                        targetRow.observation = '';
                    }
                }
				applyFilters();
			});
		});
		calculateAndDisplayTotals(dataToRender);
	}

	function populateSucursalFilter(uniqueSucursales) {
		sucursalFilterSelect.innerHTML = '<option value="">Todas las Sucursales</option>';
		Array.from(uniqueSucursales).sort().forEach(sucursal => {
			sucursalFilterSelect.innerHTML += `<option value="${sucursal}">${sucursal}</option>`;
		});
	}

	function applyFilters() {
		const filterStartDate = startDateInput.value ? normalizeDate(startDateInput.value) : null;
		const filterEndDate = endDateInput.value ? normalizeDate(endDateInput.value) : null;
		const selectedSucursal = sucursalFilterSelect.value;
		
        const filteredRows = allTableRowsData.filter(row => {
			const rowDateNormalized = normalizeDate(row.date.split(' ')[0]);
			const dateMatch = (!filterStartDate || (rowDateNormalized && rowDateNormalized >= filterStartDate)) &&
							  (!filterEndDate || (rowDateNormalized && rowDateNormalized <= filterEndDate));
			const sucursalMatch = !selectedSucursal || row.sucursal === selectedSucursal;
			return dateMatch && sucursalMatch;
		});
		renderTable(filteredRows);
	}

	function clearFilters() {
		startDateInput.value = '';
		endDateInput.value = '';
		sucursalFilterSelect.value = '';
		renderTable(allTableRowsData);
	}

    async function downloadExcel() {
        if (currentFilteredAndRenderedRows.length === 0) {
            alert("No hay datos para descargar.");
            return;
        }
        try {
            const response = await fetch(downloadUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(currentFilteredAndRenderedRows)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Error al generar el archivo.');
            }

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'reporte_nomina_formateado.xlsx';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();

        } catch (error) {
            console.error('Error en la descarga:', error);
            alert(`No se pudo descargar el archivo: ${error.message}`);
        }
    }

	applyFiltersBtn.addEventListener('click', applyFilters);
	clearFiltersBtn.addEventListener('click', clearFilters);
    downloadExcelBtn.addEventListener('click', downloadExcel);
	
	</script>
</body>
</html>
