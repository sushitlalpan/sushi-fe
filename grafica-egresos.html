<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Panel Profesional - Egresos</title>
    <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="css/grafica-egresos.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
</head>
<body>
    
    <main id="main-content">
        <header>
            <h1>Panel Profesional - Egresos</h1>
        </header>
        <div class="filters">
            <select id="filtroSucursal">
                <option value="all">Cargando sucursales...</option>
            </select>
            <input type="date" id="fechaInicio" />
            <input type="date" id="fechaFin" />
        </div>
        <div class="chart-container">
            <div class="chart-box">
                <div class="chart-title">Gastos Diarios</div>
                <canvas id="gastosDiariosChart"></canvas>
            </div>
            <div class="chart-box">
                <div class="chart-title">Gastos Acumulados Mensuales</div>
                <canvas id="gastosMensualesChart"></canvas>
            </div>
            <div class="chart-box">
                <div class="chart-title">Distribución de Gastos por Concepto</div>
                <canvas id="gastosPorConceptoChart"></canvas>
            </div>
            <div class="chart-box">
                <div class="chart-title">Distribución de Gastos por Sucursal</div>
                <canvas id="gastosPorSucursalChart"></canvas>
            </div>
        </div>
    </main>
    <script src="js/api-client.js"></script>
    <script src="js/auth-guard.js"></script>
    <script src="js/branches.js"></script>
    <script src="js/egresos.js"></script>
    <script>
        let originalData = [];
        let charts = {};
        let currentFilters = {};

        // CORRECCIÓN: Registrar los plugins globalmente una sola vez al inicio.
        Chart.register(ChartDataLabels);

        document.addEventListener("DOMContentLoaded", function() {
            initializeDashboard();
        });

        async function initializeDashboard() {
            await populateSucursalFilter();
            await loadEgresosData();

            document.querySelectorAll('.filters input, .filters select').forEach(el => {
                el.addEventListener('change', () => applyFilters());
            });
        }
        
        async function populateSucursalFilter() {
            try {
                const data = await branchesAPI.getBranches();
                const sucursales = data.branches || [];
                const select = document.getElementById('filtroSucursal');
                select.innerHTML = '<option value="all">Todas las Sucursales</option>';
                
                // Sort branches by name
                const sortedBranches = sucursales.sort((a, b) => {
                    const nameA = typeof a === 'string' ? a : (a.name || 'N/A');
                    const nameB = typeof b === 'string' ? b : (b.name || 'N/A');
                    return nameA.localeCompare(nameB);
                });
                
                sortedBranches.forEach(branch => {
                    const branchName = typeof branch === 'string' ? branch : (branch.name || 'N/A');
                    const branchId = typeof branch === 'string' ? branch : (branch.id || branchName);
                    const opt = document.createElement('option');
                    opt.value = branchId;
                    opt.textContent = branchName;
                    select.appendChild(opt);
                });
            } catch (error) {
                console.error('Error al cargar sucursales:', error);
                document.getElementById('filtroSucursal').innerHTML = '<option value="all">Error al cargar</option>';
            }
        }

        async function loadEgresosData(filters = null) {
            try {
                // Use provided filters or keep current filters
                if (filters !== null) {
                    currentFilters = filters;
                }
                
                const data = await egresosAPI.getEgresosList(0, currentFilters);
                const expenses = data.expenses || [];
                
                originalData = expenses.map(item => ({
                    fecha: item.expense_date ? new Date(item.expense_date + 'T00:00:00') : null,
                    sucursal: item.branch_name || 'N/A',
                    branchId: item.branch_id,
                    concepto: item.expense_category || 'N/A',
                    descripcion: item.expense_description || '',
                    proveedor: item.vendor_payee || '',
                    total: parseFloat(item.total_amount) || 0,
                    cantidad: parseFloat(item.quantity) || 0,
                    metodoPago: item.payment_method || 'cash'
                })).filter(item => item.fecha && !isNaN(item.fecha));

                renderCharts(originalData);
            } catch (error) {
                console.error('Error al cargar datos de egresos:', error);
                alert('Error al cargar los datos de egresos.');
            }
        }

        async function applyFilters() {
            const filters = {};
            
            const sucursal = document.getElementById('filtroSucursal').value;
            const fechaInicioStr = document.getElementById('fechaInicio').value;
            const fechaFinStr = document.getElementById('fechaFin').value;
            
            if (sucursal && sucursal !== 'all') {
                filters.branch_id = sucursal;
            }
            if (fechaInicioStr) {
                filters.start_date = fechaInicioStr;
            }
            if (fechaFinStr) {
                filters.end_date = fechaFinStr;
            }
            
            await loadEgresosData(filters);
        }
        
        function renderCharts(data) {
            Object.values(charts).forEach(chart => {
                if(chart) chart.destroy();
            });

            const dailyData = data.reduce((acc, { fecha, total }) => {
                if (fecha) {
                    const key = fecha.toISOString().split('T')[0];
                    acc[key] = (acc[key] || 0) + total;
                }
                return acc;
            }, {});
            const dailyLabels = Object.keys(dailyData).sort();
            const dailyValues = dailyLabels.map(label => dailyData[label]);

            const monthlyData = data.reduce((acc, { fecha, total }) => {
                if (fecha) {
                    const key = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;
                    acc[key] = (acc[key] || 0) + total;
                }
                return acc;
            }, {});
            const monthlyKeys = Object.keys(monthlyData).sort();
            const monthlyLabels = monthlyKeys.map(key => {
                const [year, month] = key.split('-');
                const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                return `${monthNames[parseInt(month) - 1]} ${year}`;
            });
            const monthlyValues = monthlyKeys.map(key => monthlyData[key]);

            const byConcepto = data.reduce((acc, { concepto, total }) => {
                if (concepto) {
                    acc[concepto] = (acc[concepto] || 0) + total;
                }
                return acc;
            }, {});
            const labelsConcepto = Object.keys(byConcepto);
            const dataConcepto = Object.values(byConcepto);

            const bySucursal = data.reduce((acc, { sucursal, total }) => {
                if (sucursal) {
                    acc[sucursal] = (acc[sucursal] || 0) + total;
                }
                return acc;
            }, {});
            const labelsSucursal = Object.keys(bySucursal);
            const dataSucursal = Object.values(bySucursal);

            const chartColors = ['#e94a7e', '#f0d44c', '#41c5d3', '#9b59b6', '#3498db', '#e67e22', '#2ecc71', '#e74c3c'];
            const tooltipCurrency = { plugins: { tooltip: { callbacks: { label: ctx => {
                const value = typeof ctx.parsed === 'object' ? (ctx.parsed.y || ctx.parsed) : ctx.parsed;
                return `$${value.toLocaleString('es-MX', {minimumFractionDigits: 2})}`;
            } } } } };

            charts.gastosDiarios = new Chart('gastosDiariosChart', {
                type: 'line',
                data: {
                    labels: dailyLabels,
                    datasets: [{ label: 'Gastos', data: dailyValues, borderColor: '#e74c3c', backgroundColor: 'rgba(231, 76, 60, 0.2)', fill: true, tension: 0.3 }]
                },
                options: tooltipCurrency
            });

            charts.gastosMensuales = new Chart('gastosMensualesChart', {
                type: 'bar',
                data: {
                    labels: monthlyLabels,
                    datasets: [{ label: 'Gastos', data: monthlyValues, backgroundColor: '#2ecc71' }]
                },
                options: tooltipCurrency
            });

            charts.gastosPorConcepto = new Chart('gastosPorConceptoChart', {
                type: 'doughnut',
                data: { 
                    labels: labelsConcepto, 
                    // CORRECCIÓN: Se arregló el error de tipeo "Gastros"
                    datasets: [{ label: 'Gastos', data: dataConcepto, backgroundColor: chartColors }] 
                },
                options: { plugins: { legend: { position: 'right' }, ...tooltipCurrency.plugins } }
            });

            charts.gastosPorSucursal = new Chart('gastosPorSucursalChart', {
                type: 'pie',
                data: { 
                    labels: labelsSucursal, 
                    datasets: [{ label: 'Gastos', data: dataSucursal, backgroundColor: chartColors.slice().reverse() }] 
                },
                options: { plugins: { legend: { position: 'right' }, ...tooltipCurrency.plugins } }
            });
        }
    </script>
</body>
</html>